{% extends 'base/base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid py-4" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh;">
  <!-- Header Section -->
  <div class="row mb-5">
    <div class="col-12 text-center text-white">
      <h1 class="display-4 fw-bold mb-3">
        <i class="fas fa-graduation-cap me-3"></i>
        Mes Mati√®res 
        {% if student_grade %}
          <span class="badge bg-light text-dark fs-6">{{ student_grade }}</span>
        {% endif %}
      </h1>
      <!-- Assistant Lottie (click to open chat modal) -->
      <div style="margin-top:12px; display:flex; align-items:center; gap:12px; justify-content:center;">
        <div id="assistant-lottie-trigger" style="display:inline-block; cursor:pointer;">
          <!-- placeholder for lottie animation -->
          <div id="assistant-lottie" style="width:120px;height:120px;margin:0 auto"></div>
        </div>
        <!-- Accessible fallback button if Lottie fails -->
        <button id="open-assistant-fallback" class="btn btn-light btn-sm" style="display:none;">
          <i class="fas fa-robot me-1"></i>Parler √† l'assistant
        </button>
      </div>
      <p class="lead opacity-90">
        D√©couvrez vos mati√®res et commencez votre apprentissage
      </p>
    </div>
  </div>

  <!-- Search Section -->
  <div class="row justify-content-center mb-5">
    <div class="col-lg-8 col-xl-6">
      <form method="get" class="position-relative">
        <div class="input-group shadow-lg" style="border-radius: 25px; overflow: hidden;">
          <input 
            type="text" 
            name="search" 
            class="form-control border-0 py-3 px-4" 
            placeholder="üîç Rechercher une mati√®re..." 
            value="{{ search_query }}"
            style="font-size: 1.1rem; background: rgba(255,255,255,0.95);"
          >
          <button class="btn btn-primary px-4" type="submit" style="border: none;">
            <i class="fas fa-search"></i>
          </button>
          {% if search_query %}
            <a href="{% url 'student_subjects_list' %}" class="btn btn-outline-secondary px-4" style="border: none;">
              <i class="fas fa-times"></i>
            </a>
          {% endif %}
        </div>
      </form>
    </div>
  </div>

  <!-- Subjects Grid -->
  <div class="container">
    <div class="row g-4">
      {% for item in subjects_with_indicators %}
        <div class="col-lg-4 col-md-6 col-12">
          <a href="{% url 'student_subject_detail' item.subject.pk %}" class="text-decoration-none">
            <div class="card subject-card h-100 border-0 shadow-sm position-relative overflow-hidden" 
                 style="border-radius: 20px; transition: all 0.3s ease; background: white;">
              
              <!-- New Badge -->
              {% if item.has_new %}
                <div class="position-absolute top-0 end-0 m-3" style="z-index: 10;">
                  <span class="badge bg-danger pulse-animation px-3 py-2 rounded-pill">
                    <i class="fas fa-star me-1"></i>Nouveau!
                  </span>
                </div>
              {% endif %}

              <!-- Subject Image -->
              {% if item.subject.image %}
                <div class="card-img-container" style="height: 220px; overflow: hidden;">
                  <img 
                    src="{{ item.subject.image.url }}" 
                    class="card-img-top w-100" 
                    alt="{{ item.subject.name }}"
                    style="height: 100%; object-fit: cover; transition: transform 0.3s ease;"
                  />
                  <div class="overlay position-absolute top-0 start-0 w-100 h-100" 
                       style="background: linear-gradient(45deg, {{ item.subject.color }}22, {{ item.subject.color }}44);"></div>
                </div>
              {% else %}
                <div class="card-img-top d-flex align-items-center justify-content-center" 
                     style="height: 220px; background: linear-gradient(135deg, {{ item.subject.color }}22, {{ item.subject.color }}44);">
                  {% if item.subject.icon %}
                    <i class="fas {{ item.subject.icon }} fa-4x" style="color: {{ item.subject.color }};"></i>
                  {% else %}
                    <i class="fas fa-book fa-4x text-muted"></i>
                  {% endif %}
                </div>
              {% endif %}

              <!-- Card Body -->
              <div class="card-body p-4 d-flex flex-column">
                <div class="d-flex align-items-center mb-3">
                  {% if item.subject.icon %}
                    <div class="icon-circle me-3 d-flex align-items-center justify-content-center" 
                         style="width: 50px; height: 50px; background: {{ item.subject.color }}22; border-radius: 15px;">
                      <i class="fas {{ item.subject.icon }} fa-lg" style="color: {{ item.subject.color }};"></i>
                    </div>
                  {% endif %}
                  <div class="flex-grow-1">
                    <h5 class="card-title mb-0 fw-bold text-dark">{{ item.subject.name }}</h5>
                    <small class="text-muted">{{ item.subject.grade_level }}</small>
                  </div>
                </div>

                <p class="card-text text-muted flex-grow-1 mb-3" style="line-height: 1.6;">
                  {{ item.subject.description|truncatechars:120 }}
                </p>

                <!-- Stats Footer -->
                <div class="d-flex justify-content-between align-items-center mt-auto pt-3 border-top">
                  <div class="d-flex align-items-center">
                    <span class="badge rounded-pill px-3 py-2" 
                          style="background: {{ item.subject.color }}22; color: {{ item.subject.color }};">
                      <i class="fas fa-book-open me-1"></i>
                      {{ item.subject.topic_count }} th√®me{{ item.subject.topic_count|pluralize }}
                    </span>
                  </div>
                  <div class="text-end">
                    <i class="fas fa-arrow-right text-muted"></i>
                  </div>
                </div>
              </div>

              <!-- Hover Effect Border -->
              <div class="position-absolute top-0 start-0 w-100 h-100" 
                   style="border: 3px solid {{ item.subject.color }}; border-radius: 20px; opacity: 0; transition: opacity 0.3s ease;"></div>
            </div>
          </a>
        </div>
      {% empty %}
        <div class="col-12">
          <div class="text-center py-5">
            <div class="card border-0 shadow-sm mx-auto" style="max-width: 500px; border-radius: 20px;">
              <div class="card-body p-5">
                <div class="mb-4">
                  <i class="fas fa-graduation-cap fa-4x text-muted opacity-50"></i>
                </div>
                <h4 class="text-dark mb-3">Aucune mati√®re disponible</h4>
                <p class="text-muted mb-4">
                  Vous n'avez pas encore √©t√© invit√© √† des classes. 
                  Contactez votre professeur ou revenez plus tard !
                </p>
                <div class="d-flex justify-content-center gap-2">
                  <span class="badge bg-light text-dark px-3 py-2 rounded-pill">
                    <i class="fas fa-clock me-1"></i>En attente
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
</div>

<style>
  .subject-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 20px 40px rgba(0,0,0,0.1) !important;
  }
  
  .subject-card:hover .card-img-top {
    transform: scale(1.05);
  }
  
  .subject-card:hover .position-absolute {
    opacity: 1 !important;
  }
  
  .pulse-animation {
    animation: pulse 2s infinite;
  }
  
  @keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
  }
  
  .icon-circle {
    transition: all 0.3s ease;
  }
  
  .subject-card:hover .icon-circle {
    transform: scale(1.1);
  }
  
  .input-group:focus-within {
    transform: translateY(-2px);
    transition: transform 0.3s ease;
  }
</style>
{% endblock %}

{% block extra_js %}
  <!-- Load lottie and assistant chat script only on this page -->
  <script src="{% static 'js/lottie.min.js' %}"></script>
  <script>
    (function(){
      const trigger = document.getElementById('assistant-lottie-trigger');
      const animEl = document.getElementById('assistant-lottie');
      // Load animation JSON and render small Lottie. If lottie isn't present, try to load it dynamically.
      function showFallback() {
        const fb = document.getElementById('open-assistant-fallback');
        if (fb) fb.style.display = 'inline-block';
      }

      function loadAnimationData() {
        if (!animEl) { showFallback(); return; }
        // Prevent multiple animations
        if (window.__lottie_animation_loaded) { return; }
        window.__lottie_animation_loaded = true;
        animEl.innerHTML = ''; // Clear any existing content
        fetch('{% static "animations/assistant_lottie.json" %}')
          .then(r => { if (!r.ok) throw new Error('not ok'); return r.json(); })
          .then(data => {
            try {
              window.lottie.loadAnimation({
                container: animEl,
                renderer: 'svg',
                loop: true,
                autoplay: true,
                animationData: data
              });
            } catch (err) { showFallback(); }
          }).catch(()=>{ showFallback(); });
      }

      if (window.lottie) {
        loadAnimationData();
      } else {
        // Try to load lottie script dynamically and then load animation
        const lottieScript = document.createElement('script');
        lottieScript.src = '{% static "js/lottie.min.js" %}';
        lottieScript.onload = () => { loadAnimationData(); };
        lottieScript.onerror = () => { showFallback(); };
        document.head.appendChild(lottieScript);
      }

      // Prepare modal markup for assistant chat (Bootstrap modal) - DESIGN ENFANTS
      const modalHtml = `
      <style>
        /* Design pour enfants - Modal Chatbot */
        #assistantChatModal .modal-dialog { max-width: 900px !important; }
        #assistantChatModal .modal-content { 
          border-radius: 24px !important; 
          border: 4px solid #667eea !important;
          box-shadow: 0 10px 40px rgba(0,0,0,0.3) !important;
        }
        #assistantChatModal .modal-header { 
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
          color: white !important;
          border-radius: 20px 20px 0 0 !important;
          padding: 20px !important;
        }
        #assistantChatModal .modal-title { 
          font-family: 'Comic Sans MS', cursive !important;
          font-size: 28px !important;
          font-weight: bold !important;
          text-shadow: 2px 2px 4px rgba(0,0,0,0.2) !important;
        }
        #assistantChatModal .btn-close {
          filter: brightness(0) invert(1) !important;
          opacity: 1 !important;
        }
        #assistantChatModal .modal-body {
          background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%) !important;
          padding: 24px !important;
          font-family: 'Comic Sans MS', cursive !important;
        }
        #assistantChatModal .chat-wrap {
          background: white !important;
          border-radius: 20px !important;
          padding: 20px !important;
          box-shadow: 0 4px 12px rgba(0,0,0,0.1) !important;
        }
        #assistantChatModal .header-controls {
          display: flex !important;
          justify-content: space-between !important;
          align-items: center !important;
          margin-bottom: 16px !important;
          padding: 12px !important;
          background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%) !important;
          border-radius: 12px !important;
        }
        #assistantChatModal .header-controls label {
          color: white !important;
          font-weight: bold !important;
          margin: 0 !important;
          font-size: 15px !important;
        }
        #assistantChatModal #language {
          padding: 6px 12px !important;
          border-radius: 10px !important;
          border: 2px solid white !important;
          font-weight: bold !important;
          cursor: pointer !important;
          margin-left: 8px !important;
        }
        #assistantChatModal #messages {
          height: 420px !important;
          overflow-y: auto !important;
          border: 3px solid #667eea !important;
          border-radius: 16px !important;
          padding: 16px !important;
          background: linear-gradient(to bottom, #ffecd2 0%, #fcb69f 100%) !important;
          margin-bottom: 16px !important;
        }
        #assistantChatModal #messages::-webkit-scrollbar {
          width: 10px !important;
        }
        #assistantChatModal #messages::-webkit-scrollbar-thumb {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
          border-radius: 10px !important;
        }
        #assistantChatModal .clearfix {
          clear: both !important;
          height: 0 !important;
          overflow: hidden !important;
        }
        #assistantChatModal .msg {
          padding: 12px 16px !important;
          margin: 10px 0 !important;
          border-radius: 18px !important;
          max-width: 75% !important;
          word-wrap: break-word !important;
          line-height: 1.5 !important;
          font-size: 15px !important;
          box-shadow: 0 3px 8px rgba(0,0,0,0.15) !important;
          animation: messageSlide 0.3s ease-out !important;
        }
        @keyframes messageSlide {
          from { opacity: 0; transform: translateY(10px); }
          to { opacity: 1; transform: translateY(0); }
        }
        #assistantChatModal .msg.student {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
          color: white !important;
          float: right !important;
          clear: right !important;
          text-align: left !important;
          border-bottom-right-radius: 4px !important;
        }
        #assistantChatModal .msg.student::before {
          content: 'üë¶ ' !important;
          font-size: 16px !important;
        }
        #assistantChatModal .msg.assistant {
          background: white !important;
          color: #333 !important;
          float: left !important;
          clear: left !important;
          text-align: left !important;
          border: 3px solid #667eea !important;
          border-bottom-left-radius: 4px !important;
        }
        #assistantChatModal .msg.assistant::before {
          content: 'ü§ñ ' !important;
          font-size: 16px !important;
        }
        #assistantChatModal .controls {
          display: flex !important;
          gap: 10px !important;
          align-items: center !important;
        }
        #assistantChatModal #input {
          flex: 1 !important;
          height: 60px !important;
          padding: 12px !important;
          border: 3px solid #667eea !important;
          border-radius: 16px !important;
          font-size: 15px !important;
          font-family: 'Comic Sans MS', cursive !important;
          resize: none !important;
          transition: all 0.3s !important;
        }
        #assistantChatModal #input:focus {
          outline: none !important;
          border-color: #764ba2 !important;
          box-shadow: 0 0 0 3px rgba(118, 75, 162, 0.2) !important;
        }
        #assistantChatModal #mic-btn {
          width: 50px !important;
          height: 50px !important;
          border-radius: 50% !important;
          background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%) !important;
          border: none !important;
          color: white !important;
          font-size: 20px !important;
          cursor: pointer !important;
          transition: all 0.3s !important;
          box-shadow: 0 4px 10px rgba(0,0,0,0.15) !important;
        }
        #assistantChatModal #mic-btn:hover {
          transform: scale(1.1) !important;
        }
        #assistantChatModal #mic-btn.recording {
          background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%) !important;
          animation: pulse 1s infinite !important;
        }
        @keyframes pulse {
          0%, 100% { transform: scale(1); }
          50% { transform: scale(1.1); }
        }
        #assistantChatModal #send {
          padding: 12px 28px !important;
          border-radius: 16px !important;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
          border: none !important;
          color: white !important;
          font-weight: bold !important;
          font-size: 16px !important;
          cursor: pointer !important;
          transition: all 0.3s !important;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
        }
        #assistantChatModal #send:hover {
          transform: translateY(-2px) !important;
          box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4) !important;
        }
        #assistantChatModal .info-text {
          text-align: center !important;
          margin-top: 12px !important;
          color: #666 !important;
          font-size: 13px !important;
        }
        #assistantChatModal .search-bar {
          display: flex !important;
          gap: 10px !important;
          align-items: center !important;
          padding: 12px !important;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
          border-radius: 12px !important;
          margin: 10px 0 !important;
        }
        #assistantChatModal #search-query {
          flex: 1 !important;
          padding: 10px 14px !important;
          border-radius: 10px !important;
          border: 2px solid white !important;
          font-size: 14px !important;
          font-weight: bold !important;
        }
        #assistantChatModal #search-btn {
          padding: 10px 16px !important;
          background: white !important;
          color: #667eea !important;
          border: none !important;
          border-radius: 10px !important;
          font-weight: bold !important;
          cursor: pointer !important;
        }
        #assistantChatModal #search-results {
          background: #f8f9fa !important;
          border: 2px dashed #667eea !important;
          border-radius: 10px !important;
          padding: 10px !important;
          margin: 10px 0 !important;
          max-height: 200px !important;
          overflow-y: auto !important;
        }
        /* PDF History Button */
        #assistantChatModal #toggle-pdf-history {
          padding: 8px 16px !important;
          background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important;
          color: white !important;
          border: none !important;
          border-radius: 10px !important;
          font-weight: bold !important;
          cursor: pointer !important;
          font-size: 14px !important;
          transition: all 0.3s !important;
          box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3) !important;
        }
        #assistantChatModal #toggle-pdf-history:hover {
          transform: translateY(-2px) !important;
          box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4) !important;
        }
        /* PDF History Panel */
        #assistantChatModal .pdf-history-panel {
          display: none !important;
          background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%) !important;
          border-radius: 12px !important;
          padding: 16px !important;
          margin: 12px 0 !important;
          border: 3px solid #fbbf24 !important;
          box-shadow: 0 4px 12px rgba(0,0,0,0.1) !important;
          position: relative !important;
          z-index: 10 !important;
          min-height: 100px !important;
        }
        #assistantChatModal .pdf-history-panel.active {
          display: block !important;
        }
        #assistantChatModal .pdf-history-header {
          display: flex !important;
          justify-content: space-between !important;
          align-items: center !important;
          margin-bottom: 16px !important;
          padding-bottom: 12px !important;
          border-bottom: 2px dashed #fbbf24 !important;
        }
        #assistantChatModal .pdf-history-header h3 {
          margin: 0 !important;
          color: #92400e !important;
          font-size: 1.3rem !important;
          font-family: 'Comic Sans MS', cursive !important;
        }
        #assistantChatModal .close-history-btn {
          background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%) !important;
          color: white !important;
          border: none !important;
          padding: 6px 12px !important;
          border-radius: 8px !important;
          cursor: pointer !important;
          font-weight: bold !important;
          transition: all 0.3s !important;
        }
        #assistantChatModal .close-history-btn:hover {
          transform: scale(1.05) !important;
        }
        #assistantChatModal #pdf-list-container {
          min-height: 50px !important;
          width: 100% !important;
          display: block !important;
        }
        #assistantChatModal .pdf-list {
          display: flex !important;
          flex-direction: column !important;
          gap: 12px !important;
          max-height: 300px !important;
          overflow-y: auto !important;
          width: 100% !important;
        }
        #assistantChatModal .pdf-item {
          display: flex !important;
          align-items: center !important;
          gap: 12px !important;
          padding: 12px !important;
          border-radius: 12px !important;
          border: 2px solid rgba(255,255,255,0.5) !important;
          transition: all 0.3s !important;
          box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
        }
        #assistantChatModal .pdf-item:hover {
          transform: translateY(-3px) !important;
          box-shadow: 0 6px 16px rgba(0,0,0,0.15) !important;
        }
        #assistantChatModal .pdf-icon {
          font-size: 2rem !important;
          flex-shrink: 0 !important;
        }
        #assistantChatModal .pdf-info {
          flex: 1 !important;
          min-width: 0 !important;
        }
        #assistantChatModal .pdf-title {
          font-weight: bold !important;
          color: #1e40af !important;
          margin: 0 0 4px 0 !important;
          font-size: 1rem !important;
          font-family: 'Comic Sans MS', cursive !important;
        }
        #assistantChatModal .pdf-meta {
          font-size: 0.85rem !important;
          color: #6b7280 !important;
        }
        #assistantChatModal .pdf-actions {
          display: flex !important;
          gap: 8px !important;
          flex-shrink: 0 !important;
        }
        #assistantChatModal .btn-download {
          background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important;
          color: white !important;
          text-decoration: none !important;
          padding: 8px 12px !important;
          border-radius: 8px !important;
          font-size: 0.9rem !important;
          display: inline-flex !important;
          align-items: center !important;
          gap: 4px !important;
          transition: all 0.3s !important;
          font-weight: bold !important;
          box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3) !important;
        }
        #assistantChatModal .btn-download:hover {
          transform: translateY(-2px) !important;
          box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4) !important;
        }
        #assistantChatModal .empty-state {
          text-align: center !important;
          padding: 40px 20px !important;
          color: #6b7280 !important;
        }
        #assistantChatModal .empty-state-icon {
          font-size: 4rem !important;
          margin-bottom: 16px !important;
        }
        /* PDF History Modal Styles */
        #pdfHistoryModal .pdf-list {
          display: flex !important;
          flex-direction: column !important;
          gap: 12px !important;
          width: 100% !important;
        }
        #pdfHistoryModal .pdf-item {
          display: flex !important;
          align-items: center !important;
          gap: 12px !important;
          padding: 16px !important;
          border-radius: 12px !important;
          border: 2px solid rgba(255,255,255,0.7) !important;
          transition: all 0.3s !important;
          box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
          min-height: 80px !important;
        }
        #pdfHistoryModal .pdf-item:hover {
          transform: translateY(-3px) !important;
          box-shadow: 0 6px 16px rgba(0,0,0,0.15) !important;
        }
        #pdfHistoryModal .pdf-icon {
          font-size: 2.5rem !important;
          flex-shrink: 0 !important;
        }
        #pdfHistoryModal .pdf-info {
          flex: 1 !important;
          min-width: 0 !important;
        }
        #pdfHistoryModal .pdf-title {
          font-weight: bold !important;
          color: #1e40af !important;
          margin: 0 0 6px 0 !important;
          font-size: 1.1rem !important;
          font-family: 'Comic Sans MS', cursive, sans-serif !important;
        }
        #pdfHistoryModal .pdf-meta {
          font-size: 0.9rem !important;
          color: #6b7280 !important;
          margin-bottom: 4px !important;
        }
        #pdfHistoryModal .pdf-actions {
          display: flex !important;
          gap: 8px !important;
          flex-shrink: 0 !important;
        }
        #pdfHistoryModal .btn-download {
          background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important;
          color: white !important;
          text-decoration: none !important;
          padding: 10px 16px !important;
          border-radius: 8px !important;
          font-size: 0.95rem !important;
          display: inline-flex !important;
          align-items: center !important;
          gap: 6px !important;
          transition: all 0.3s !important;
          font-weight: bold !important;
          box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3) !important;
          border: none !important;
        }
        #pdfHistoryModal .btn-download:hover {
          transform: translateY(-2px) !important;
          box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4) !important;
          text-decoration: none !important;
        }
        #pdfHistoryModal .empty-state {
          text-align: center !important;
          padding: 40px 20px !important;
          color: #6b7280 !important;
        }
        #pdfHistoryModal .empty-state-icon {
          font-size: 4rem !important;
          margin-bottom: 16px !important;
        }
      </style>
      <div class="modal fade" id="assistantChatModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title"> EduKids Assistant ‚ú® </h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div id="assistant-chat-root">
                <div class="chat-wrap">
                  <div class="header-controls">
                    <div>
                      <label for="language">üåç Language:</label>
                      <select id="language" class="lang">
                        <option value="fr">üá´üá∑ Fran√ßais</option>
                        <option value="en">üá¨üáß English</option>
                        <option value="es">üá™üá∏ Espa√±ol</option>
                        <option value="pt">üáµüáπ Portugu√™s</option>
                        <option value="ar">üá∏üá¶ ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
                      </select>
                    </div>
                    <div>
                      <label><input type="checkbox" id="tts" checked> üîä Voice Reading</label>
                    </div>
                    <div>
                      <button id="toggle-pdf-history" data-bs-toggle="modal" data-bs-target="#pdfHistoryModal">üìÑ My PDFs</button>
                    </div>
                  </div>
                  
                  <!-- Barre de recherche -->
                  <div class="search-bar">
                    <input type="text" id="search-query" placeholder="üîç Search in history..." />
                    <button id="search-btn">üîé Search</button>
                  </div>
                  
                  <!-- Zone de r√©sultats de recherche -->
                  <div id="search-results" style="display:none;"></div>
                  
                  <div class="messages" id="messages"></div>
                  <div class="controls">
                    <textarea id="input" placeholder="üí¨ Type your message here..." aria-label="message"></textarea>
                    <button id="mic-btn" title="üé§ Record a voice message" class="btn">
                      <i class="fas fa-microphone"></i>
                    </button>
                    <button id="send" class="primary btn">‚ú® Send</button>
                  </div>
                  <div class="info-text">
                    <small>üí° You can type or talk using the microphone! The full chat history is displayed</small>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>`;

      // La modal sera cr√©√©e dynamiquement dans openAssistant() au premier clic

      function openAssistant() {
        console.log('üéØ openAssistant appel√©');
        
        // CR√âER LA MODAL SI ELLE N'EXISTE PAS ENCORE
        let modalEl = document.getElementById('assistantChatModal');
        
        if (!modalEl) {
          console.log('üìù Cr√©ation de la modal dans le DOM...');
          try {
            const tmp = document.createElement('div');
            tmp.innerHTML = modalHtml.trim();
            
            // modalHtml contient <style> + <div class="modal">
            // On doit trouver la div.modal, pas le style
            const styleEl = tmp.querySelector('style');
            const modalNode = tmp.querySelector('.modal');
            
            if (!modalNode) {
              console.error('‚ùå Impossible de trouver .modal dans modalHtml');
              console.log('tmp.children:', tmp.children);
              alert('Erreur: Structure de modal invalide');
              return;
            }
            
            // Ajouter le style ET la modal au body
            if (styleEl) {
              document.head.appendChild(styleEl);
              console.log('‚úÖ Style CSS ajout√©');
            }
            document.body.appendChild(modalNode);
            console.log('‚úÖ Modal ajout√©e au DOM');
            
            // Maintenant chercher la modal
            modalEl = document.getElementById('assistantChatModal');
            console.log('üîç Recherche getElementById apr√®s ajout:', modalEl);
            
            if (!modalEl) {
              console.error('‚ùå Modal ajout√©e mais non trouv√©e par getElementById!');
              console.log('Cherchons avec querySelector:', document.querySelector('#assistantChatModal'));
              console.log('Cherchons avec .modal:', document.querySelector('.modal'));
              alert('Erreur: Modal ajout√©e mais non accessible');
              return;
            }
          } catch(err) {
            console.error('‚ùå Erreur lors de la cr√©ation de la modal:', err);
            alert('Erreur cr√©ation modal: ' + err.message);
            return;
          }
        } else {
          console.log('‚úÖ Modal d√©j√† pr√©sente dans le DOM');
        }
        
        // store student id for assistant to load history
        try {
          const studentId = '{{ user.id|default:"" }}';
          if (studentId) {
            localStorage.setItem('edukids_student_id', studentId);
            console.log('‚úÖ Student ID sauvegard√©:', studentId);
          }
        } catch(e){
          console.error('‚ùå Erreur sauvegarde student ID:', e);
        }

        // Load assistant script dynamically if not loaded
        if (!window.__assistant_chat_loaded) {
          console.log('üì• Chargement du script assistant_chat.js...');
          const s = document.createElement('script');
          s.src = '/static/js/assistant_chat.js';
          s.onload = () => { 
            window.__assistant_chat_loaded = true;
            console.log('‚úÖ Script assistant_chat.js charg√©');
          };
          s.onerror = () => {
            console.error('‚ùå Erreur chargement assistant_chat.js');
          };
          document.body.appendChild(s);
        } else {
          console.log('‚úÖ Script assistant_chat.js d√©j√† charg√©');
        }

        // show bootstrap modal - utiliser getOrCreateInstance pour eviter les erreurs
        console.log('üîç Modal element final:', modalEl);
        
        if (modalEl) {
          // V√©rifier si Bootstrap est disponible
          if (typeof bootstrap === 'undefined') {
            console.error('‚ùå Bootstrap n\'est pas charg√©!');
            alert('Erreur: Bootstrap n\'est pas charg√©. Rechargez la page.');
            return;
          }
          
          console.log('‚úÖ Bootstrap disponible');
          try {
            // Utiliser getOrCreateInstance au lieu de new Modal
            const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
            console.log('‚úÖ Modal instance cr√©√©e:', modal);
            
            modal.show();
            console.log('üéâ Modal show() appel√©e!');
            
          } catch(err) {
            console.error('‚ùå Erreur cr√©ation/affichage modal:', err);
            alert('Erreur ouverture modal: ' + err.message);
          }
        } else {
          console.error('‚ùå Element modal non trouv√© apr√®s tentative de cr√©ation!');
          alert('Erreur: Modal non trouv√©e dans le DOM');
        }
      }

      console.log('üîç Recherche du trigger...');
      if (trigger) {
        console.log('‚úÖ Trigger trouv√©:', trigger);
        trigger.addEventListener('click', openAssistant);
        console.log('‚úÖ Event listener ajout√© sur trigger');
        
        // also open if user clicks the Lottie container inside
        const animInner = document.getElementById('assistant-lottie');
        console.log('üîç Recherche de assistant-lottie:', animInner);
        if (animInner) {
          animInner.addEventListener('click', openAssistant);
          console.log('‚úÖ Event listener ajout√© sur Lottie');
        } else {
          console.warn('‚ö†Ô∏è Element assistant-lottie non trouv√©');
        }
        } else {
          console.error('‚ùå Trigger non trouv√©!');
        }
      
            
      // ========= CREATE AND INITIALIZE PDF HISTORY MODAL =========
      window.createPDFHistoryModal = function() {
        console.log('üìö Creating PDF History Modal...');
        
        // Check if modal already exists
        if (document.getElementById('pdfHistoryModal')) {
          console.log('üìö PDF Modal already exists');
          return document.getElementById('pdfHistoryModal');
        }
        
        // Create modal HTML
        const modalHTML = `
          <div class="modal fade" id="pdfHistoryModal" tabindex="-1" aria-labelledby="pdfHistoryModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-scrollable">
              <div class="modal-content" style="border-radius: 20px; border: none; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
                <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 20px 20px 0 0;">
                  <h5 class="modal-title" id="pdfHistoryModalLabel" style="font-weight: bold;">
                    üìö My PDF Documents.
                  </h5>
                  <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" style="background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); padding: 20px;">
                  <div id="pdf-modal-list-container">
                    <div class="empty-state" style="text-align: center; padding: 40px 20px;">
                      <div class="empty-state-icon" style="font-size: 4rem; margin-bottom: 15px;">üìÑ</div>
                      <p style="color: #667eea; font-size: 16px;">Chargement des PDFs...</p>
                    </div>
                  </div>
                </div>
                <div class="modal-footer" style="background: #f8f9fa; border-radius: 0 0 20px 20px;">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‚úï Close</button>
                </div>
              </div>
            </div>
          </div>
        `;
        
        // Append to body
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        console.log('‚úÖ PDF Modal added to body');
        
        const pdfModal = document.getElementById('pdfHistoryModal');
        
        // Set up event listener to load PDFs when modal is shown
        pdfModal.addEventListener('shown.bs.modal', function() {
          console.log('üéâ PDF Modal shown - loading PDFs...');
          window.loadPDFHistoryInModal();
        });
        
        console.log('‚úÖ PDF Modal initialized');
        return pdfModal;
      };
      
      // Load PDF history from API into modal
      window.loadPDFHistoryInModal = function() {
        console.log('üì• Chargement des PDFs dans le modal...');
        
        const pdfModalListContainer = document.getElementById('pdf-modal-list-container');
        if (!pdfModalListContainer) {
          console.error('‚ùå Container not found');
          return;
        }
        
        const studentId = localStorage.getItem('edukids_student_id');
        if (!studentId) {
          console.error('‚ùå Student ID non trouv√©');
          pdfModalListContainer.innerHTML = `
            <div class="empty-state" style="text-align: center; padding: 40px 20px;">
              <div class="empty-state-icon" style="font-size: 4rem;">‚ö†Ô∏è</div>
              <p style="color: #ef4444;">Erreur: Identifiant √©tudiant non trouv√©.</p>
            </div>
          `;
          return;
        }
        
        pdfModalListContainer.innerHTML = `
          <div class="empty-state" style="text-align: center; padding: 40px 20px;">
            <div class="empty-state-icon" style="font-size: 4rem;">‚è≥</div>
            <p style="color: #667eea;">Chargement des PDFs...</p>
          </div>
        `;
        
        fetch(`/assistant/api/pdf_history/?student_id=${studentId}`)
          .then(response => {
            if (!response.ok) throw new Error('Erreur r√©seau');
            return response.json();
          })
          .then(data => {
            console.log('‚úÖ PDFs charg√©s:', data);
            
            if (!data.pdfs || data.pdfs.length === 0) {
              pdfModalListContainer.innerHTML = `
                <div class="empty-state" style="text-align: center; padding: 40px 20px;">
                  <div class="empty-state-icon" style="font-size: 4rem;">üì≠</div>
                  <p style="color: #667eea;">No PDF found. Ask the assistant to create a PDF!</p>
                </div>
              `;
              return;
            }
            
            console.log('üìä Nombre de PDFs:', data.pdfs.length);
            
            // Render PDF list with pastel colors
            const pdfItems = data.pdfs.map((pdf, index) => {
              const colors = ['#FFD6E8', '#D6E8FF', '#FFF9D6', '#D6FFE8', '#E8D6FF', '#FFE8D6', '#D6FFF0'];
              const bgColor = colors[index % colors.length];
              const date = new Date(pdf.created_at);
              const formattedDate = date.toLocaleDateString('fr-FR', { 
                day: '2-digit', 
                month: 'long', 
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
              });
              
              console.log(`üìÑ PDF ${index + 1}:`, pdf.title, 'URL:', pdf.file_url);
              
              return `
                <div class="pdf-item" style="background: ${bgColor};">
                  <div class="pdf-icon">üìÑ</div>
                  <div class="pdf-info">
                    <h4 class="pdf-title">${pdf.title || 'Document PDF'}</h4>
                    <div class="pdf-meta">
                      üìÖ ${formattedDate}
                      ${pdf.conversation_title ? `<br>üí¨ ${pdf.conversation_title}` : ''}
                    </div>
                  </div>
                  <div class="pdf-actions">
                    <a href="${pdf.file_url}" target="_blank" class="btn-download" download>
                      ‚¨áÔ∏è T√©l√©charger
                    </a>
                  </div>
                </div>
              `;
            }).join('');
            
            console.log('üìù HTML g√©n√©r√©, longueur:', pdfItems.length, 'caract√®res');
            
            const fullHTML = `<div class="pdf-list">${pdfItems}</div>`;
            pdfModalListContainer.innerHTML = fullHTML;
            
            console.log('‚úÖ HTML ins√©r√© dans le modal');
            console.log('üì¶ Nombre de PDFs affich√©s:', data.pdfs.length);
          })
          .catch(error => {
            console.error('‚ùå Erreur chargement PDFs:', error);
            pdfModalListContainer.innerHTML = `
              <div class="empty-state" style="text-align: center; padding: 40px 20px;">
                <div class="empty-state-icon" style="font-size: 4rem;">‚ùå</div>
                <p style="color: #ef4444;">Erreur lors du chargement des PDFs.</p>
              </div>
            `;
          });
      };
      
      // Set up global click handler for PDF history button
      document.addEventListener('click', function(e) {
        if (e.target && e.target.id === 'toggle-pdf-history') {
          console.log('üîò PDF History button clicked');
          e.preventDefault();
          e.stopPropagation();
          
          // Create modal if it doesn't exist
          let pdfModal = document.getElementById('pdfHistoryModal');
          if (!pdfModal) {
            pdfModal = window.createPDFHistoryModal();
          }
          
          // Show the modal
          if (pdfModal && typeof bootstrap !== 'undefined') {
            const modalInstance = bootstrap.Modal.getOrCreateInstance(pdfModal);
            modalInstance.show();
            console.log('‚úÖ PDF Modal shown');
          } else {
            console.error('‚ùå Cannot show PDF modal - Bootstrap or modal not found');
          }
        }
      }, true); // Use capture phase to ensure we catch it first
      
      // Initialize the PDF modal when document is ready
      document.addEventListener('DOMContentLoaded', function() {
        console.log('ÔøΩ DOM Ready - initializing PDF modal...');
        // Wait a bit for the modal HTML to be in DOM
        setTimeout(() => {
          if (typeof window.initializePDFHistoryModal === 'function') {
            window.initializePDFHistoryModal();
          }
        }, 500);
      });
    })();
  </script>
{% endblock %}
