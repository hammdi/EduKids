{% extends 'base/base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid py-4" style="background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); min-height: 100vh;">
  <!-- Breadcrumb -->
  <div class="container mb-4">
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb bg-white rounded-pill px-4 py-3 shadow-sm">
        <li class="breadcrumb-item">
          <a href="{% url 'subjects_list' %}" class="text-decoration-none fw-medium">
            <i class="fas fa-home me-2"></i>Matières
          </a>
        </li>
        <li class="breadcrumb-item">
          <a href="{% url 'subject_detail' exercise.topic.subject.pk %}" class="text-decoration-none fw-medium">
            {{ exercise.topic.subject.name }}
          </a>
        </li>
        <li class="breadcrumb-item">
          <a href="{% url 'topic_detail' exercise.topic.pk %}" class="text-decoration-none fw-medium">
            {{ exercise.topic.name }}
          </a>
        </li>
        <li class="breadcrumb-item active fw-bold" aria-current="page" style="color: {{ exercise.topic.subject.color }};">
          {{ exercise.name }}
        </li>
      </ol>
    </nav>
  </div>

  <!-- Exercise Header -->
  <div class="container mb-5">
    <div class="row">
      <div class="col-12">
        <div class="card border-0 shadow-lg overflow-hidden" style="border-radius: 25px;">
          <!-- Header Background -->
          <div class="position-relative" 
               style="background: linear-gradient(135deg, {{ exercise.topic.subject.color }}08, {{ exercise.topic.subject.color }}15); height: 220px;">
            
            <!-- Content -->
            <div class="position-absolute bottom-0 start-0 p-4 w-100">
              <div class="d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center">
                  <div class="icon-container me-4 d-flex align-items-center justify-content-center" 
                       style="width: 80px; height: 80px; background: white; border-radius: 20px; box-shadow: 0 8px 25px rgba(0,0,0,0.08);">
                    <i class="fas fa-pencil-alt fa-2x" style="color: {{ exercise.topic.subject.color }};"></i>
                  </div>
                  <div class="flex-grow-1">
                    <h1 class="mb-2 fw-bold text-dark">
                      {{ exercise.name }}
                      <span class="badge rounded-pill px-3 py-2 ms-3" 
                            style="background: {{ exercise.topic.subject.color }}15; color: {{ exercise.topic.subject.color }}; font-size: 0.6rem;">
                        {{ exercise.exercise_type }}
                      </span>
                    </h1>
                    <p class="lead mb-0 text-dark opacity-75" style="font-size: 1rem;">
                      Type: {{ exercise.exercise_type }}, Difficulté: {{ exercise.difficulty }}
                    </p>
                    <p class="mb-0 text-dark opacity-75" style="font-size: 0.95rem;">
                      {{ exercise.description|truncatechars:150 }}
                    </p>
                  </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="d-flex gap-3">
                  {% if user == exercise.creator %}
                    <a href="?edit=exercise" class="btn btn-outline-light rounded-pill px-4">
                      <i class="fas fa-edit me-2"></i>Modifier l'exercice
                    </a>
                    {% if exercise.exercise_type == 'QCM' %}
                      <button type="button" class="btn btn-light rounded-pill px-4" 
                              data-bs-toggle="modal" data-bs-target="#generateAIModal"
                              style="background: white; color: {{ exercise.topic.subject.color }}; border: 2px solid {{ exercise.topic.subject.color }};">
                        <i class="fas fa-robot me-2"></i>Générer avec IA
                      </button>
                    {% endif %}
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- Edit Form (Enhanced) -->
    {% if exercise_form %}
    <div class="row mb-5">
      <div class="col-12">
        <div class="card border-0 shadow-lg" style="border-radius: 25px;">
          <div class="card-header border-0 p-4" 
               style="background: linear-gradient(135deg, {{ exercise.topic.subject.color }}05, {{ exercise.topic.subject.color }}08); border-radius: 25px 25px 0 0;">
            <h3 class="fw-bold text-dark mb-0">
              <i class="fas fa-edit me-3" style="color: {{ exercise.topic.subject.color }};"></i>
              Modifier l'exercice
            </h3>
          </div>
          <div class="card-body p-5">
            <form method="post" enctype="multipart/form-data">
              {% csrf_token %}
              <input type="hidden" name="update_exercise" value="1">
              
              <div class="row g-4">
                <div class="col-md-6">
                  <label class="form-label fw-bold text-dark mb-2">
                    <i class="fas fa-tag me-2" style="color: {{ exercise.topic.subject.color }};"></i>
                    Nom de l'exercice
                  </label>
                  {{ exercise_form.name.as_widget }}
                  <small class="text-muted">Nom court et descriptif</small>
                </div>

                <div class="col-md-6">
                  <label class="form-label fw-bold text-dark mb-2">
                    <i class="fas fa-cogs me-2" style="color: {{ exercise.topic.subject.color }};"></i>
                    Type d'exercice
                  </label>
                  {{ exercise_form.exercise_type.as_widget }}
                  <small class="text-muted">Format de l'exercice</small>
                </div>

                <div class="col-12">
                  <label class="form-label fw-bold text-dark mb-2">
                    <i class="fas fa-align-left me-2" style="color: {{ exercise.topic.subject.color }};"></i>
                    Description
                  </label>
                  {{ exercise_form.description.as_widget }}
                  <small class="text-muted">Description détaillée de l'exercice</small>
                </div>

                <div class="col-md-6">
                  <label class="form-label fw-bold text-dark mb-2">
                    <i class="fas fa-layer-group me-2" style="color: {{ exercise.topic.subject.color }};"></i>
                    Difficulté
                  </label>
                  {{ exercise_form.difficulty.as_widget }}
                  <small class="text-muted">Niveau de difficulté</small>
                </div>

                <div class="col-md-6">
                  <label class="form-label fw-bold text-dark mb-2">
                    <i class="fas fa-star me-2" style="color: {{ exercise.topic.subject.color }};"></i>
                    Points
                  </label>
                  {{ exercise_form.points.as_widget }}
                  <small class="text-muted">Points pour cet exercice</small>
                </div>
              </div>
              
              <div class="d-flex gap-3 mt-5">
                <button type="submit" class="btn btn-success btn-lg rounded-pill px-5">
                  <i class="fas fa-save me-2"></i>Sauvegarder les modifications
                </button>
                <a href="{% url 'exercise_detail' exercise.pk %}" class="btn btn-outline-secondary btn-lg rounded-pill px-4">
                  <i class="fas fa-times me-2"></i>Annuler
                </a>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
    {% endif %}

    <!-- Questions Section -->
    <div class="row mb-5">
      <div class="col-12">
        <div class="d-flex align-items-center justify-content-between mb-4">
          <h2 class="fw-bold text-dark mb-0">
            <i class="fas fa-question-circle me-3" style="color: {{ exercise.topic.subject.color }};"></i>
            Questions
          </h2>
          <div class="d-flex align-items-center gap-3">
            <div class="badge bg-light text-dark px-3 py-2 rounded-pill">
              {{ questions|length }} question{{ questions|length|pluralize }}
            </div>
            {% if user == exercise.creator and exercise.exercise_type == 'QCM' %}
              <button type="button" class="btn btn-outline-secondary rounded-pill px-4" 
                      data-bs-toggle="modal" data-bs-target="#generateAIModal">
                <i class="fas fa-robot me-2"></i>Générer avec IA
              </button>
            {% endif %}
            <button type="button" class="btn rounded-pill px-4" 
                    style="background: {{ exercise.topic.subject.color }}; border: none; color: white;"
                    data-bs-toggle="modal" data-bs-target="#addQuestionModal">
              <i class="fas fa-plus me-2"></i>Ajouter une question
            </button>
          </div>
        </div>

        <div class="row g-4">
          {% for question in questions %}
          <div class="col-12">
            <div class="card question-card border-0 shadow-sm" 
                 style="border-radius: 20px; border-left: 5px solid {{ exercise.topic.subject.color }};">
              <div class="card-body p-4">
                <div class="d-flex align-items-start justify-content-between mb-3">
                  <div class="d-flex align-items-start">
                    <div class="question-number me-3 d-flex align-items-center justify-content-center fw-bold text-white" 
                         style="width: 45px; height: 45px; background: {{ exercise.topic.subject.color }}; border-radius: 50%; flex-shrink: 0;">
                      {{ forloop.counter }}
                    </div>
                    <div class="flex-grow-1">
                      <h5 class="fw-bold text-dark mb-2">{{ question.question_text }}</h5>
                      <div class="d-flex gap-2 flex-wrap mb-3">
                        <span class="badge rounded-pill" 
                              style="background: {{ exercise.topic.subject.color }}08; color: {{ exercise.topic.subject.color }};">
                          <i class="fas fa-cogs me-1"></i>{{ question.question_type }}
                        </span>
                        <span class="badge bg-light text-dark rounded-pill">
                          <i class="fas fa-star me-1"></i>{{ question.points }} pts
                        </span>
                      </div>
                      {% if question.hint %}
                        <p class="text-muted small mb-0">
                          <i class="fas fa-lightbulb me-1"></i>Indice: {{ question.hint }}
                        </p>
                      {% endif %}
                    </div>
                  </div>

                  {% if user == exercise.creator %}
                  <div class="dropdown">
                    <button class="btn btn-light rounded-circle p-2" type="button" 
                            data-bs-toggle="dropdown" aria-expanded="false"
                            style="width: 40px; height: 40px;">
                      <i class="fas fa-ellipsis-v"></i>
                    </button>
                    <ul class="dropdown-menu shadow-sm">
                      <li>
                        <button class="dropdown-item" type="button">
                          <i class="fas fa-edit me-2"></i>Modifier
                        </button>
                      </li>
                      <li><hr class="dropdown-divider"></li>
                      <li>
                        <form method="post" action="{% url 'delete_question' question.pk %}" 
                              style="display: inline"
                              onsubmit="return confirm('Êtes-vous sûr de vouloir supprimer cette question ?')">
                          {% csrf_token %}
                          <button type="submit" class="dropdown-item text-danger">
                            <i class="fas fa-trash me-2"></i>Supprimer
                          </button>
                        </form>
                      </li>
                    </ul>
                  </div>
                  {% endif %}
                </div>

                <!-- Answers/Options -->
                <div class="mt-4 ms-5">
                  <h6 class="fw-bold text-dark mb-3">Réponses:</h6>
                  {% for answer in question.answers.all %}
                  <div class="d-flex align-items-start p-3 mb-2 rounded-3" 
                       style="background: {{ answer.is_correct|yesno:'#d4edda,#f8f9fa' }}; border: 1px solid {{ answer.is_correct|yesno:'#c3e6cb,#dee2e6' }};">
                    <i class="fas fa-{{ answer.is_correct|yesno:'check-circle,circle' }} me-3 mt-1" 
                       style="color: {{ answer.is_correct|yesno:'#28a745,#6c757d' }};"></i>
                    <div class="flex-grow-1">
                      <span class="text-dark">{{ answer.answer_text }}</span>
                      {% if answer.explanation %}
                        <small class="d-block text-muted mt-1">{{ answer.explanation }}</small>
                      {% endif %}
                    </div>
                  </div>
                  {% endfor %}
                  
                  <!-- Add Answer Button -->
                  <button type="button" class="btn btn-sm btn-outline-primary rounded-pill mt-2" 
                          data-bs-toggle="modal" data-bs-target="#addAnswerModal{{ question.pk }}">
                    <i class="fas fa-plus me-1"></i>Ajouter une réponse
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Modal for Adding Answer -->
          <div class="modal fade" id="addAnswerModal{{ question.pk }}" tabindex="-1" 
               aria-labelledby="addAnswerModalLabel{{ question.pk }}" aria-hidden="true">
            <div class="modal-dialog">
              <div class="modal-content" style="border-radius: 20px; border: none;">
                <div class="modal-header" 
                     style="background: linear-gradient(135deg, {{ exercise.topic.subject.color }}05, {{ exercise.topic.subject.color }}08); border-radius: 20px 20px 0 0;">
                  <h5 class="modal-title fw-bold" id="addAnswerModalLabel{{ question.pk }}">
                    <i class="fas fa-plus me-2" style="color: {{ exercise.topic.subject.color }};"></i>
                    Ajouter une réponse
                  </h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="post">
                  {% csrf_token %}
                  <input type="hidden" name="add_answer" value="1" />
                  <input type="hidden" name="question_id" value="{{ question.pk }}" />
                  <div class="modal-body p-4">
                    <div class="mb-3">
                      <label class="form-label fw-bold text-dark mb-2">
                        <i class="fas fa-comment me-2" style="color: {{ exercise.topic.subject.color }};"></i>
                        Texte de la réponse
                      </label>
                      <input type="text" name="answer_text" 
                             class="form-control form-control-lg rounded-pill px-4"
                             placeholder="Entrez le texte de la réponse..."
                             style="border: 2px solid #e2e8f0;" maxlength="200" required>
                    </div>
                    <div class="mb-3">
                      <div class="form-check">
                        <input type="checkbox" name="is_correct" 
                               class="form-check-input" id="is_correct{{ question.pk }}"
                               style="border: 2px solid #e2e8f0;">
                        <label class="form-check-label fw-bold text-dark" for="is_correct{{ question.pk }}">
                          <i class="fas fa-check me-2" style="color: {{ exercise.topic.subject.color }};"></i>
                          Cette réponse est correcte
                        </label>
                      </div>
                    </div>
                    <div class="mb-3">
                      <label class="form-label fw-bold text-dark mb-2">
                        <i class="fas fa-info-circle me-2" style="color: {{ exercise.topic.subject.color }};"></i>
                        Explication (optionnel)
                      </label>
                      <textarea name="explanation" 
                                class="form-control form-control-lg rounded-3 px-4 py-3"
                                rows="3"
                                placeholder="Expliquez pourquoi cette réponse est correcte ou incorrecte..."
                                style="border: 2px solid #e2e8f0; resize: vertical;"></textarea>
                    </div>
                  </div>
                  <div class="modal-footer" style="background: #f8fafc; border-radius: 0 0 20px 20px;">
                    <button type="button" class="btn btn-outline-secondary rounded-pill px-4" data-bs-dismiss="modal">
                      <i class="fas fa-times me-2"></i>Annuler
                    </button>
                    <button type="submit" class="btn rounded-pill px-4" 
                            style="background: {{ exercise.topic.subject.color }}; border: none; color: white;">
                      <i class="fas fa-save me-2"></i>Ajouter la réponse
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
          {% empty %}
          <div class="col-12">
            <div class="text-center py-5">
              <div class="card border-0 shadow-sm mx-auto" style="max-width: 600px; border-radius: 25px;">
                <div class="card-body p-5">
                  <div class="mb-4">
                    <div class="empty-icon mx-auto d-flex align-items-center justify-content-center" 
                         style="width: 120px; height: 120px; background: {{ exercise.topic.subject.color }}08; border-radius: 50%;">
                      <i class="fas fa-question-circle fa-3x" style="color: {{ exercise.topic.subject.color }}; opacity: 0.5;"></i>
                    </div>
                  </div>
                  <h4 class="text-dark mb-3 fw-bold">Aucune question disponible</h4>
                  <p class="text-muted mb-4 lead">
                    Commencez par créer votre première question pour cet exercice.
                  </p>
                  <div class="d-flex gap-3 justify-content-center">
                    {% if user == exercise.creator and exercise.exercise_type == 'QCM' %}
                      <button type="button" class="btn btn-outline-secondary rounded-pill px-4" 
                              data-bs-toggle="modal" data-bs-target="#generateAIModal">
                        <i class="fas fa-robot me-2"></i>Générer avec IA
                      </button>
                    {% endif %}
                    <button type="button" class="btn rounded-pill px-4" 
                            style="background: {{ exercise.topic.subject.color }}; border: none; color: white;"
                            data-bs-toggle="modal" data-bs-target="#addQuestionModal">
                      <i class="fas fa-plus me-2"></i>Créer une question
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Enhanced Modal for Adding Question -->
<div class="modal fade" id="addQuestionModal" tabindex="-1" aria-labelledby="addQuestionModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content" style="border-radius: 20px; border: none;">
      <div class="modal-header" 
           style="background: linear-gradient(135deg, {{ exercise.topic.subject.color }}05, {{ exercise.topic.subject.color }}08); border-radius: 20px 20px 0 0;">
        <h5 class="modal-title fw-bold" id="addQuestionModalLabel">
          <i class="fas fa-plus me-2" style="color: {{ exercise.topic.subject.color }};"></i>
          Ajouter une nouvelle question
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" id="question-form">
        {% csrf_token %}
        <input type="hidden" name="add_question" value="1" />
        <div class="modal-body p-4">
          {% if exercise.exercise_type == 'QCM' %}
          <div class="mb-4">
            <p class="text-muted">Créez une question à choix multiples avec plusieurs options de réponse.</p>
          </div>
          
          <div class="row g-4">
            <div class="col-12">
              <label class="form-label fw-bold text-dark mb-2">
                <i class="fas fa-question me-2" style="color: {{ exercise.topic.subject.color }};"></i>
                Énoncé de la question
              </label>
              {{ question_form.question_text.as_widget }}
              <small class="text-muted">Formulez clairement votre question</small>
            </div>
            <div class="col-md-4">
              <label class="form-label fw-bold text-dark mb-2">
                <i class="fas fa-cogs me-2" style="color: {{ exercise.topic.subject.color }};"></i>
                Type
              </label>
              {{ question_form.question_type.as_widget }}
            </div>
            <div class="col-md-4">
              <label class="form-label fw-bold text-dark mb-2">
                <i class="fas fa-star me-2" style="color: {{ exercise.topic.subject.color }};"></i>
                Points
              </label>
              {{ question_form.points.as_widget }}
            </div>
            <div class="col-md-4">
              <label class="form-label fw-bold text-dark mb-2">
                <i class="fas fa-lightbulb me-2" style="color: {{ exercise.topic.subject.color }};"></i>
                Indice (optionnel)
              </label>
              {{ question_form.hint.as_widget }}
            </div>
          </div>

          <h4 class="mt-4 mb-3 fw-bold text-dark">
            <i class="fas fa-list me-2" style="color: {{ exercise.topic.subject.color }};"></i>
            Options de réponse
          </h4>
          <div style="display: none">
            <input type="hidden" name="form-TOTAL_FORMS" value="1" id="id_form-TOTAL_FORMS" />
            <input type="hidden" name="form-INITIAL_FORMS" value="0" id="id_form-INITIAL_FORMS" />
            <input type="hidden" name="form-MIN_NUM_FORMS" value="0" id="id_form-MIN_NUM_FORMS" />
            <input type="hidden" name="form-MAX_NUM_FORMS" value="1000" id="id_form-MAX_NUM_FORMS" />
          </div>
          <div id="answer-forms">
            <div class="answer-form card border-0 shadow-sm mb-3" style="border-radius: 15px;">
              <div class="card-body p-3">
                <div class="row g-3">
                  <div class="col-md-8">
                    <label class="form-label fw-bold text-dark">Texte de la réponse</label>
                    <input type="text" name="form-0-answer_text" maxlength="200" 
                           class="form-control form-control-lg rounded-pill px-4"
                           placeholder="Entrez le texte de cette option..."
                           style="border: 2px solid #e2e8f0;" />
                  </div>
                  <div class="col-md-4 d-flex align-items-end">
                    <div class="form-check">
                      <input type="checkbox" name="form-0-is_correct" 
                             class="form-check-input" id="form-0-is_correct">
                      <label class="form-check-label fw-bold text-dark" for="form-0-is_correct">
                        Réponse correcte
                      </label>
                    </div>
                  </div>
                  <div class="col-12">
                    <label class="form-label fw-bold text-dark">Explication (optionnel)</label>
                    <textarea name="form-0-explanation" 
                              class="form-control form-control-lg rounded-3 px-4 py-3"
                              rows="2"
                              placeholder="Expliquez cette réponse..."
                              style="border: 2px solid #e2e8f0; resize: vertical;"></textarea>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <button type="button" id="add-answer" class="btn btn-outline-secondary rounded-pill px-4">
            <i class="fas fa-plus me-2"></i>Ajouter une autre option
          </button>

          {% elif exercise.exercise_type == 'trous' %}
          <div class="mb-4">
            <p class="text-muted">Créez un exercice à trous en sélectionnant les mots à cacher.</p>
          </div>
          
          <div class="row g-4">
            <div class="col-12">
              <label class="form-label fw-bold text-dark mb-2">
                <i class="fas fa-edit me-2" style="color: {{ exercise.topic.subject.color }};"></i>
                Texte complet
              </label>
              <textarea id="full_text" 
                        class="form-control form-control-lg rounded-3 px-4 py-3"
                        rows="4"
                        placeholder="Tapez le texte complet, puis sélectionnez un mot et cliquez sur 'Cacher le mot'..."
                        style="border: 2px solid #e2e8f0; resize: vertical;"></textarea>
              <button type="button" id="hide_word" class="btn btn-outline-primary rounded-pill px-4 mt-2">
                <i class="fas fa-eye-slash me-2"></i>Cacher le mot sélectionné
              </button>
            </div>
            <div class="col-12">
              <label class="form-label fw-bold text-dark mb-2">
                <i class="fas fa-question me-2" style="color: {{ exercise.topic.subject.color }};"></i>
                Question avec trous
              </label>
              <textarea name="question_text" id="id_question_text" 
                        class="form-control form-control-lg rounded-3 px-4 py-3"
                        rows="3"
                        style="border: 2px solid #e2e8f0; resize: vertical;"></textarea>
            </div>
            <div class="col-md-4">
              <label class="form-label fw-bold text-dark mb-2">Type</label>
              {{ question_form.question_type.as_widget }}
            </div>
            <div class="col-md-4">
              <label class="form-label fw-bold text-dark mb-2">Points</label>
              {{ question_form.points.as_widget }}
            </div>
            <div class="col-md-4">
              <label class="form-label fw-bold text-dark mb-2">Indice</label>
              {{ question_form.hint.as_widget }}
            </div>
            <div class="col-12">
              <h4 class="fw-bold text-dark mb-3">Réponse</h4>
              <div style="display: none">
                {{ answer_formset.management_form }}
              </div>
              <div class="card border-0 shadow-sm" style="border-radius: 15px;">
                <div class="card-body p-3">
                  <div class="row g-3">
                    <div class="col-md-8">
                      <label class="form-label fw-bold text-dark">Mot de réponse</label>
                      <input type="text" name="form-0-answer_text" 
                             class="form-control form-control-lg rounded-pill px-4"
                             placeholder="Le mot qui remplit le trou..."
                             style="border: 2px solid #e2e8f0;" />
                    </div>
                    <div class="col-12">
                      <label class="form-label fw-bold text-dark">Explication</label>
                      <textarea name="form-0-explanation" 
                                class="form-control form-control-lg rounded-3 px-4 py-3"
                                rows="2"
                                placeholder="Explication de la réponse..."
                                style="border: 2px solid #e2e8f0; resize: vertical;"></textarea>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          {% elif exercise.exercise_type == 'dictée' %}
          <div class="mb-4">
            <p class="text-muted">Créez un exercice de dictée avec le texte à lire aux étudiants.</p>
          </div>
          
          <div class="row g-4">
            <div class="col-12">
              <label class="form-label fw-bold text-dark mb-2">
                <i class="fas fa-microphone me-2" style="color: {{ exercise.topic.subject.color }};"></i>
                Texte de dictée
              </label>
              {{ question_form.question_text.as_widget }}
              <small class="text-muted">Texte qui sera lu à haute voix aux étudiants</small>
            </div>
            <div class="col-md-4">
              <label class="form-label fw-bold text-dark mb-2">Type</label>
              {{ question_form.question_type.as_widget }}
            </div>
            <div class="col-md-4">
              <label class="form-label fw-bold text-dark mb-2">Points</label>
              {{ question_form.points.as_widget }}
            </div>
            <div class="col-md-4">
              <label class="form-label fw-bold text-dark mb-2">Indice</label>
              {{ question_form.hint.as_widget }}
            </div>
          </div>

          {% else %}
          <div class="alert alert-warning" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i>
            Type d'exercice non pris en charge.
          </div>
          {% endif %}
        </div>
        <div class="modal-footer" style="background: #f8fafc; border-radius: 0 0 20px 20px;">
          <button type="button" class="btn btn-outline-secondary rounded-pill px-4" data-bs-dismiss="modal">
            <i class="fas fa-times me-2"></i>Annuler
          </button>
          <button type="submit" class="btn rounded-pill px-4" 
                  style="background: {{ exercise.topic.subject.color }}; border: none; color: white;">
            <i class="fas fa-save me-2"></i>Créer la question
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Enhanced Modal for AI Generation -->
<div class="modal fade" id="generateAIModal" tabindex="-1" aria-labelledby="generateAIModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content" style="border-radius: 20px; border: none;">
      <div class="modal-header" 
           style="background: linear-gradient(135deg, {{ exercise.topic.subject.color }}05, {{ exercise.topic.subject.color }}08); border-radius: 20px 20px 0 0;">
        <h5 class="modal-title fw-bold" id="generateAIModalLabel">
          <i class="fas fa-robot me-2" style="color: {{ exercise.topic.subject.color }};"></i>
          Générer des questions avec IA
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" action="{% url 'generate_ai_questions' exercise.pk %}">
        {% csrf_token %}
        <div class="modal-body p-4">
          <div class="mb-4">
            <p class="text-muted">Utilisez l'intelligence artificielle pour générer automatiquement des questions pour votre exercice.</p>
          </div>
          
          <div class="row g-4">
            <div class="col-md-6">
              <label class="form-label fw-bold text-dark mb-2">
                <i class="fas fa-hashtag me-2" style="color: {{ exercise.topic.subject.color }};"></i>
                Nombre de questions
              </label>
              <input type="number" name="num_questions" 
                     class="form-control form-control-lg rounded-pill px-4"
                     min="1" max="10" value="5" required
                     style="border: 2px solid #e2e8f0;">
              <small class="text-muted">Entre 1 et 10 questions</small>
            </div>
            <div class="col-md-6">
              <label class="form-label fw-bold text-dark mb-2">
                <i class="fas fa-layer-group me-2" style="color: {{ exercise.topic.subject.color }};"></i>
                Difficulté
              </label>
              <select name="difficulty" 
                      class="form-select form-select-lg rounded-pill px-4"
                      style="border: 2px solid #e2e8f0;">
                <option value="easy">Facile</option>
                <option value="medium" selected>Moyen</option>
                <option value="hard">Difficile</option>
              </select>
            </div>
            <div class="col-12">
              <label class="form-label fw-bold text-dark mb-2">
                <i class="fas fa-magic me-2" style="color: {{ exercise.topic.subject.color }};"></i>
                Instructions personnalisées (optionnel)
              </label>
              <textarea name="custom_prompt" 
                        class="form-control form-control-lg rounded-3 px-4 py-3"
                        rows="3"
                        placeholder="Ex: Concentrez-vous sur les verbes français, incluez des exemples concrets..."
                        style="border: 2px solid #e2e8f0; resize: vertical;"></textarea>
              <small class="text-muted">Guidez l'IA avec des instructions spécifiques</small>
            </div>
          </div>
        </div>
        <div class="modal-footer" style="background: #f8fafc; border-radius: 0 0 20px 20px;">
          <button type="button" class="btn btn-outline-secondary rounded-pill px-4" data-bs-dismiss="modal">
            <i class="fas fa-times me-2"></i>Annuler
          </button>
          <button type="submit" class="btn btn-success rounded-pill px-4">
            <i class="fas fa-magic me-2"></i>Générer les questions
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<style>
  .question-card:hover {
    box-shadow: 0 15px 40px rgba(0,0,0,0.1) !important;
    transform: translateY(-2px);
    transition: all 0.3s ease;
  }
  
  .breadcrumb-item + .breadcrumb-item::before {
    content: "›";
    font-weight: bold;
    color: #6c757d;
  }
  
  .icon-container:hover {
    transform: scale(1.02);
    transition: transform 0.3s ease;
  }
  
  .form-control, .form-select {
    border: 2px solid #e2e8f0 !important;
    border-radius: 25px !important;
    padding: 12px 20px !important;
    font-size: 1rem;
    transition: all 0.3s ease;
  }
  
  .form-control:focus, .form-select:focus {
    border-color: {{ exercise.topic.subject.color }} !important;
    box-shadow: 0 0 0 0.2rem {{ exercise.topic.subject.color }}25 !important;
  }
  
  textarea.form-control {
    border-radius: 15px !important;
  }
  
  .answer-form:hover {
    transform: translateY(-2px);
    transition: all 0.3s ease;
  }
</style>

<script>
  document.addEventListener("click", function (e) {
    if (e.target.id === "add-answer") {
      e.preventDefault();
      const formset = document.getElementById("answer-forms");
      if (!formset || formset.children.length === 0) {
        console.log("No formset or no children");
        return;
      }
      const totalForms = document.querySelector('input[name="form-TOTAL_FORMS"]');
      if (!totalForms) {
        console.log("No TOTAL_FORMS found");
        return;
      }
      const newForm = formset.children[0].cloneNode(true);
      const formNum = parseInt(totalForms.value);
      newForm.innerHTML = newForm.innerHTML.replace(/form-0-/g, `form-${formNum}-`);
      formset.appendChild(newForm);
      totalForms.value = formNum + 1;
      console.log("Added new form, total now:", totalForms.value);
    }
  });

  document.getElementById("full_text")?.addEventListener("input", function () {
    document.getElementById("id_question_text").value = this.value;
  });

  document.getElementById("hide_word")?.addEventListener("click", function () {
    const fullTextArea = document.getElementById("full_text");
    const questionTextArea = document.getElementById("id_question_text");
    const answerInput = document.getElementById("id_form-0-answer_text");
    const selectedText = fullTextArea.value
      .substring(fullTextArea.selectionStart, fullTextArea.selectionEnd)
      .trim();
    if (selectedText) {
      const before = fullTextArea.value.substring(0, fullTextArea.selectionStart);
      const after = fullTextArea.value.substring(fullTextArea.selectionEnd);
      fullTextArea.value = before + "___" + after;
      questionTextArea.value = fullTextArea.value;
      answerInput.value = selectedText;
    } else {
      alert("Veuillez sélectionner un mot à cacher.");
    }
  });
</script>
{% endblock %}