<!-- filepath: EduKids/templates/exercises/exercise_detail.html -->
{% extends 'base/base.html' %} {% load static %} {% block content %}
<div class="container">
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item">
        <a href="{% url 'subjects_list' %}">Subjects</a>
      </li>
      <li class="breadcrumb-item">
        <a href="{% url 'subject_detail' exercise.topic.subject.pk %}"
          >{{ exercise.topic.subject.name }}</a
        >
      </li>
      <li class="breadcrumb-item">
        <a href="{% url 'topic_detail' exercise.topic.pk %}"
          >{{ exercise.topic.name }}</a
        >
      </li>
      <li class="breadcrumb-item active" aria-current="page">
        {{ exercise.name }}
      </li>
    </ol>
  </nav>
  <h1>{{ exercise.name }}</h1>
  <p>
    Type: {{ exercise.exercise_type }}, Difficulty: {{ exercise.difficulty }}
  </p>
  <p>{{ exercise.description }}</p>

  <h3>Questions</h3>
  {% for question in questions %}
  <div class="card mb-3">
    <div class="card-body">
      <h5 class="card-title">{{ question.question_text }}</h5>
      <p>Type: {{ question.question_type }}, Points: {{ question.points }}</p>
      {% if question.hint %}
      <p><small>Hint: {{ question.hint }}</small></p>
      {% endif %}
      <h6>Answers:</h6>
      <ul>
        {% for answer in question.answers.all %}
        <li>
          {{ answer.answer_text }} {% if answer.is_correct %} (Correct) {% endif %}
        </li>
        {% if answer.explanation %}
        <small>{{ answer.explanation }}</small>
        {% endif %} 
        {% endfor %}
      </ul>
      <!-- Button to add answer -->
      <button
        type="button"
        class="btn btn-sm btn-secondary"
        data-bs-toggle="modal"
        data-bs-target="#addAnswerModal{{ question.pk }}"
      >
        Add Answer
      </button>
    </div>
  </div>

  <!-- Modal for Adding Answer to this question -->
  <div
    class="modal fade"
    id="addAnswerModal{{ question.pk }}"
    tabindex="-1"
    aria-labelledby="addAnswerModalLabel{{ question.pk }}"
    aria-hidden="true"
  >
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addAnswerModalLabel{{ question.pk }}">
            Add Answer to "{{ question.question_text }}"
          </h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>
        <form method="post">
          {% csrf_token %}
          <input type="hidden" name="add_answer" value="1" />
          <input type="hidden" name="question_id" value="{{ question.pk }}" />
          <div class="modal-body">
            <div class="mb-3">
              <label for="id_answer_text">Answer Text</label>
              <input
                type="text"
                name="answer_text"
                id="id_answer_text"
                maxlength="200"
                required
              />
            </div>
            <div class="mb-3">
              <label for="id_is_correct">Correct?</label>
              <input type="checkbox" name="is_correct" id="id_is_correct" />
            </div>
            <div class="mb-3">
              <label for="id_explanation">Explanation</label>
              <textarea
                name="explanation"
                id="id_explanation"
                cols="40"
                rows="2"
              ></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button type="submit" class="btn btn-primary">Add Answer</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  {% empty %}
  <p>No questions yet.</p>
  {% endfor %}

  <!-- Form to add new question -->
  <h3>Add Question</h3>
  <button
    type="button"
    class="btn btn-primary"
    data-bs-toggle="modal"
    data-bs-target="#addQuestionModal"
  >
    Add Question
  </button>

  <!-- Modal for Adding Question -->
  <div
    class="modal fade"
    id="addQuestionModal"
    tabindex="-1"
    aria-labelledby="addQuestionModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addQuestionModalLabel">
            Add New Question
          </h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>
        <form method="post" id="question-form">
          {% csrf_token %}
          <input type="hidden" name="add_question" value="1" />
          <!-- Add this -->
          <div class="modal-body">
            {% if exercise.exercise_type == 'QCM' %}
            <p>Add a multiple-choice question with options.</p>
            <div class="mb-3">
              <label for="{{ question_form.question_text.id_for_label }}"
                >{{ question_form.question_text.label }}</label
              >
              {{ question_form.question_text }}
            </div>
            <div class="mb-3">
              <label for="{{ question_form.question_type.id_for_label }}"
                >{{ question_form.question_type.label }}</label
              >
              {{ question_form.question_type }}
            </div>
            <div class="mb-3">
              <label for="{{ question_form.points.id_for_label }}"
                >{{ question_form.points.label }}</label
              >
              {{ question_form.points }}
            </div>
            <div class="mb-3">
              <label for="{{ question_form.hint.id_for_label }}"
                >{{ question_form.hint.label }}</label
              >
              {{ question_form.hint }}
            </div>
            <h4>Choices</h4>
            <div style="display: none">
              <input
                type="hidden"
                name="form-TOTAL_FORMS"
                value="1"
                id="id_form-TOTAL_FORMS"
              />
              <input
                type="hidden"
                name="form-INITIAL_FORMS"
                value="0"
                id="id_form-INITIAL_FORMS"
              />
              <input
                type="hidden"
                name="form-MIN_NUM_FORMS"
                value="0"
                id="id_form-MIN_NUM_FORMS"
              />
              <input
                type="hidden"
                name="form-MAX_NUM_FORMS"
                value="1000"
                id="id_form-MAX_NUM_FORMS"
              />
            </div>
            <div id="answer-forms">
              <div class="answer-form mb-3">
                <div class="mb-2">
                  <label for="id_form-0-answer_text">Answer Text</label>
                  <input
                    type="text"
                    name="form-0-answer_text"
                    maxlength="200"
                    id="id_form-0-answer_text"
                  />
                </div>
                <div class="mb-2">
                  <label for="id_form-0-is_correct">Correct?</label>
                  <input
                    type="checkbox"
                    name="form-0-is_correct"
                    id="id_form-0-is_correct"
                  />
                </div>
                <div class="mb-2">
                  <label for="id_form-0-explanation">Explanation</label>
                  <textarea
                    name="form-0-explanation"
                    cols="40"
                    rows="2"
                    id="id_form-0-explanation"
                  ></textarea>
                </div>
              </div>
            </div>
            <button type="button" id="add-answer" class="btn btn-secondary">
              Add Another Choice
            </button>
            {% elif exercise.exercise_type == 'trous' %}
            <p>Add a fill-in-the-blank question.</p>
            <div class="mb-3">
              <label for="id_question_text">Question Text (with blanks)</label>
              <textarea
                name="question_text"
                id="id_question_text"
                rows="3"
                class="form-control"
              >
{{ question_form.question_text.value }}</textarea
              >
            </div>
            <div class="mb-3">
              <label for="full_text">Full Text (select a word to hide)</label>
              <textarea
                id="full_text"
                rows="3"
                class="form-control"
                placeholder="Type the full text here, then select a word and click Hide."
              ></textarea>
              <button
                type="button"
                id="hide_word"
                class="btn btn-secondary mt-2"
              >
                Hide Selected Word
              </button>
            </div>
            <div class="mb-3">
              <label for="id_question_type">Question Type</label>
              {{ question_form.question_type }}
            </div>
            <div class="mb-3">
              <label for="id_points">Points</label>
              {{ question_form.points }}
            </div>
            <div class="mb-3">
              <label for="id_hint">Hint</label>
              {{ question_form.hint }}
            </div>
            <h4>Answer</h4>
            <div style="display: none">
              {{ answer_formset.management_form }}
            </div>
            <div class="answer-form">
              <div class="mb-2">
                <label for="id_form-0-answer_text">Answer Text</label>
                <input
                  type="text"
                  name="form-0-answer_text"
                  id="id_form-0-answer_text"
                  maxlength="200"
                  class="form-control"
                />
              </div>
              <div class="mb-2">
                <label for="id_form-0-explanation">Explanation</label>
                <textarea
                  name="form-0-explanation"
                  id="id_form-0-explanation"
                  cols="40"
                  rows="2"
                  class="form-control"
                ></textarea>
              </div>
            </div>
            {% elif exercise.exercise_type == 'dictée' %}
            <p>
              Add a dictation exercise. Enter the text that will be read aloud
              to students.
            </p>
            <div class="mb-3">
              <label for="id_question_text">Dictation Text</label>
              {{ question_form.question_text }}
            </div>
            <div class="mb-3">
              <label for="id_question_type">Question Type</label>
              {{ question_form.question_type }}
            </div>
            <div class="mb-3">
              <label for="id_points">Points</label>
              {{ question_form.points }}
            </div>
            <div class="mb-3">
              <label for="id_hint">Hint</label>
              {{ question_form.hint }}
            </div>
            <!-- No answers needed for dictée -->
            <button type="submit" class="btn btn-primary">
              Save Dictation
            </button>
            {% else %}
            <p>Unsupported exercise type.</p>
            {% endif %}
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button type="submit" class="btn btn-primary">Save Question</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener("click", function (e) {
    if (e.target.id === "add-answer") {
      e.preventDefault(); // Prevent any default action
      const formset = document.getElementById("answer-forms");
      if (!formset || formset.children.length === 0) {
        console.log("No formset or no children");
        return;
      }
      const totalForms = document.querySelector(
        'input[name="form-TOTAL_FORMS"]'
      );
      if (!totalForms) {
        console.log("No TOTAL_FORMS found");
        return;
      }
      const newForm = formset.children[0].cloneNode(true);
      const formNum = parseInt(totalForms.value);
      newForm.innerHTML = newForm.innerHTML.replace(
        /form-0-/g,
        `form-${formNum}-`
      );
      formset.appendChild(newForm);
      totalForms.value = formNum + 1;
      console.log("Added new form, total now:", totalForms.value);
    }
  });

  document.getElementById("full_text")?.addEventListener("input", function () {
    document.getElementById("id_question_text").value = this.value;
  });

  document.getElementById("hide_word")?.addEventListener("click", function () {
    const fullTextArea = document.getElementById("full_text");
    const questionTextArea = document.getElementById("id_question_text");
    const answerInput = document.getElementById("id_form-0-answer_text");
    const selectedText = fullTextArea.value
      .substring(fullTextArea.selectionStart, fullTextArea.selectionEnd)
      .trim();
    if (selectedText) {
      // Replace selected word with ___
      const before = fullTextArea.value.substring(
        0,
        fullTextArea.selectionStart
      );
      const after = fullTextArea.value.substring(fullTextArea.selectionEnd);
      fullTextArea.value = before + "___" + after;
      // Update question text
      questionTextArea.value = fullTextArea.value;
      // Set answer
      answerInput.value = selectedText;
    } else {
      alert("Please select a word to hide.");
    }
  });
</script>
{% endblock %}
