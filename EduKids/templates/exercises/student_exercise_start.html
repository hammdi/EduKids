{% extends 'base/base.html' %} {% load static %} {% block content %}
<div class="container">
  <!-- Breadcrumb -->
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item">
        <a href="{% url 'student_subjects_list' %}">Mes Matières</a>
      </li>
      <li class="breadcrumb-item">
        <a href="{% url 'student_subject_detail' exercise.topic.subject.pk %}"
          >{{ exercise.topic.subject.name }}</a
        >
      </li>
      <li class="breadcrumb-item">
        <a href="{% url 'student_topic_detail' exercise.topic.pk %}"
          >{{ exercise.topic.name }}</a
        >
      </li>
      <li class="breadcrumb-item active" aria-current="page">
        {{ exercise.name }}
      </li>
    </ol>
  </nav>

  <!-- Exercise Header -->
  <div class="row mb-4" id="exerciseHeader">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <h1>{{ exercise.name }}</h1>
          <p class="lead">{{ exercise.description }}</p>
          <div class="row">
            <div class="col-md-3">
              <strong>Type:</strong> {{ exercise.get_exercise_type_display }}
            </div>
            <div class="col-md-3">
              <strong>Difficulté:</strong> {{ exercise.get_difficulty_display }}
            </div>
            <div class="col-md-3">
              <strong>Points:</strong> {{ exercise.points }}
            </div>
            <div class="col-md-3">
              <strong>Questions:</strong> {{ questions.count }}
            </div>
          </div>
          {% if exercise.instructions %}
          <div class="mt-3">
            <strong>Instructions:</strong>
            <p>{{ exercise.instructions }}</p>
          </div>
          {% endif %}
          <div class="mt-3">
            <button
              type="button"
              class="btn btn-primary"
              onclick="startExercise()"
            >
              <i class="fas fa-play me-1"></i>Commencer l'exercice
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Exercise Interface (Hidden initially) -->
  <div id="exerciseInterface" style="display: none">
    <!-- Progress Bar -->
    <div class="row mb-3">
      <div class="col-12">
        <div class="progress">
          <div
            class="progress-bar"
            role="progressbar"
            id="progressBar"
            style="width: 0%"
          ></div>
        </div>
        <small class="text-muted">
          Question <span id="currentQuestion">1</span> sur
          <span id="totalQuestions">{{ questions.count }}</span>
        </small>
      </div>
    </div>

    <!-- Question Container -->
    <div id="questionContainer">
      {% for question in questions %}
      <div
        class="question-slide"
        data-question-id="{{ question.pk }}"
        style="display: none"
      >
        <div class="card">
          <div class="card-body">
            <h4>Question {{ forloop.counter }}</h4>

            {% if question.image %}
            <img
              src="{{ question.image.url }}"
              alt="Question image"
              class="img-fluid mb-3"
              style="max-height: 300px"
            />
            {% endif %}

            <!-- QCM Answers -->
            {% if exercise.exercise_type == 'QCM' %}
            <p class="lead">{{ question.question_text }}</p>
            <div class="answer-choices">
              {% for answer in question.answer_choices %}
              <div class="form-check mb-2">
                <input
                  class="form-check-input"
                  type="radio"
                  name="question_{{ question.pk }}"
                  id="answer_{{ answer.pk }}"
                  value="{{ answer.pk }}"
                />
                <label class="form-check-label" for="answer_{{ answer.pk }}">
                  {{ answer.answer_text }}
                </label>
              </div>
              {% endfor %}
            </div>
            {% endif %}

            <!-- Texte à trous (Fill in the blanks) - SIMPLE -->
            {% if exercise.exercise_type == 'texte_à_trous' %}
            <div class="fill-blanks-container">
              <!-- Show the text with blanks -->
              <div class="mb-4">
                <h5>Complétez le texte:</h5>
                <div class="p-3 bg-light border rounded">
                  <p class="lead mb-0">{{ question.question_text }}</p>
                </div>
              </div>

              <!-- Simple input fields -->
              <div class="mt-4">
                <h6>Mots manquants:</h6>
                {% for answer in question.answer_choices %}
                <div class="mb-3">
                  <label class="form-label">Mot {{ forloop.counter }}:</label>
                  <input
                    type="text"
                    class="form-control fill-blank-input"
                    data-blank-number="{{ forloop.counter }}"
                    placeholder="Tapez le mot manquant..."
                  />
                </div>
                {% endfor %}
              </div>
            </div>
            {% endif %}

            <!-- Dictée Text Area - IMPROVED -->
            {% if exercise.exercise_type == 'dictée' %}
            <div class="dictee-container">
              <!-- Instructions for dictée -->
              <div class="alert alert-info mb-4">
                <h5>
                  <i class="fas fa-headphones me-2"></i>Instructions pour la
                  dictée
                </h5>
                <ul class="mb-0">
                  <li>Cliquez sur "Écouter" pour entendre la dictée</li>
                  <li>Vous pouvez l'écouter plusieurs fois</li>
                  <li>Écrivez exactement ce que vous entendez</li>
                  <li>Faites attention à l'orthographe et à la ponctuation</li>
                </ul>
              </div>

              <!-- Audio controls -->
              <div class="text-center mb-4">
                <button
                  type="button"
                  class="btn btn-primary btn-lg me-2"
                  id="playDictationBtn_{{ question.pk }}"
                  onclick="playDictation('{{ question.question_text|escapejs }}', {{ question.pk }})"
                >
                  <i class="fas fa-play me-2"></i>Écouter la dictée
                </button>

                <button
                  type="button"
                  class="btn btn-secondary btn-lg me-2"
                  onclick="playSlowDictation('{{ question.question_text|escapejs }}', {{ question.pk }})"
                >
                  <i class="fas fa-turtle me-2"></i>Écouter lentement
                </button>

                <button
                  type="button"
                  class="btn btn-outline-danger"
                  onclick="stopDictation()"
                >
                  <i class="fas fa-stop me-2"></i>Arrêter
                </button>
              </div>

              <!-- Progress indicator during speech -->
              <div
                id="speechProgress_{{ question.pk }}"
                class="mb-3"
                style="display: none"
              >
                <div class="alert alert-warning text-center">
                  <i class="fas fa-volume-up me-2"></i>
                  <span id="speechStatus_{{ question.pk }}"
                    >Lecture en cours...</span
                  >
                </div>
              </div>

              <!-- Writing area -->
              <div class="mb-4">
                <label class="form-label h5">
                  <i class="fas fa-pencil-alt me-2"></i>Écrivez ce que vous
                  entendez :
                </label>
                <textarea
                  class="form-control form-control-lg"
                  name="question_{{ question.pk }}"
                  id="dicteeAnswer_{{ question.pk }}"
                  placeholder="Écrivez ici ce que vous entendez..."
                  rows="6"
                  style="font-size: 1.1em; line-height: 1.6"
                  oninput="updateCharCount({{ question.pk }})"
                ></textarea>
                <small class="form-text text-muted mt-2">
                  <i class="fas fa-lightbulb me-1"></i>
                  Conseil : Écoutez d'abord entièrement, puis réécoutez en
                  écrivant
                </small>
              </div>

              <!-- Word count helper -->
              <div class="text-end">
                <small class="text-muted">
                  Caractères écrits :
                  <span id="charCount_{{ question.pk }}">0</span>
                </small>
              </div>
            </div>
            {% endif %} {% if question.hint %}
            <div class="mt-3">
              <button
                type="button"
                class="btn btn-outline-secondary btn-sm"
                onclick="toggleHint({{ question.pk }})"
              >
                <i class="fas fa-lightbulb me-1"></i>Voir l'indice
              </button>
              <div
                id="hint_{{ question.pk }}"
                class="alert alert-info mt-2"
                style="display: none"
              >
                {{ question.hint }}
              </div>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
      {% empty %}
      <div class="alert alert-warning">
        <h4>Aucune question trouvée</h4>
        <p>Cet exercice ne contient pas de questions.</p>
      </div>
      {% endfor %}
    </div>

    <!-- Navigation Buttons -->
    <div class="row mt-4">
      <div class="col-12 d-flex justify-content-between">
        <button
          type="button"
          class="btn btn-secondary"
          id="prevBtn"
          onclick="previousQuestion()"
          disabled
        >
          <i class="fas fa-arrow-left me-1"></i>Précédent
        </button>
        <button
          type="button"
          class="btn btn-primary"
          id="nextBtn"
          onclick="nextQuestion()"
        >
          Suivant <i class="fas fa-arrow-right ms-1"></i>
        </button>
        <button
          type="button"
          class="btn btn-success"
          id="submitBtn"
          onclick="submitExercise()"
          style="display: none"
        >
          <i class="fas fa-check me-1"></i>Terminer l'exercice
        </button>
      </div>
    </div>
  </div>

  <!-- Results Section (Hidden initially) -->
  <div id="resultsSection" style="display: none">
    <div class="row">
      <div class="col-12">
        <div class="card">
          <div class="card-body text-center">
            <h2>Résultats de l'exercice</h2>
            <div class="row mt-4">
              <div class="col-md-4">
                <h1 class="text-primary" id="scoreDisplay">0%</h1>
                <p>Score final</p>
              </div>
              <div class="col-md-4">
                <h1 class="text-success" id="correctDisplay">0</h1>
                <p>Réponses correctes</p>
              </div>
              <div class="col-md-4">
                <h1 class="text-info" id="totalDisplay">0</h1>
                <p>Questions totales</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Detailed Results -->
    <div class="row mt-4">
      <div class="col-12">
        <h3>Correction détaillée</h3>
        <div id="detailedResults"></div>
      </div>
    </div>

    <div class="row mt-4">
      <div class="col-12 text-center">
        <a
          href="{% url 'student_topic_detail' exercise.topic.pk %}"
          class="btn btn-primary"
        >
          <i class="fas fa-arrow-left me-1"></i>Retour aux exercices
        </a>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}
<script>
    let currentQuestionIndex = 0;
    let totalQuestions = {{ questions.count|default:0 }};
    let studentAnswers = {};
    let currentUtterance = null;

    // Add error checking
    if (totalQuestions === 0) {
        console.error('No questions found in exercise');
        alert('Aucune question trouvée dans cet exercice.');
    }

    function startExercise() {
        document.getElementById('exerciseHeader').style.display = 'none';
        document.getElementById('exerciseInterface').style.display = 'block';
        showQuestion(0);
    }

    function showQuestion(index) {
        // Hide all questions
        const questions = document.querySelectorAll('.question-slide');
        questions.forEach(q => q.style.display = 'none');

        // Show current question
        if (questions[index]) {
            questions[index].style.display = 'block';
            currentQuestionIndex = index;

            // Update progress
            const progress = ((index + 1) / totalQuestions) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('currentQuestion').textContent = index + 1;

            // Update total questions display
            const totalQuestionsSpan = document.getElementById('totalQuestions');
            if (totalQuestionsSpan) {
                totalQuestionsSpan.textContent = totalQuestions;
            }

            // Update navigation buttons
            document.getElementById('prevBtn').disabled = index === 0;
            document.getElementById('nextBtn').style.display = index === totalQuestions - 1 ? 'none' : 'block';
            document.getElementById('submitBtn').style.display = index === totalQuestions - 1 ? 'block' : 'none';
        }
    }

    function nextQuestion() {
        saveCurrentAnswer();
        if (currentQuestionIndex < totalQuestions - 1) {
            showQuestion(currentQuestionIndex + 1);
        }
    }

    function previousQuestion() {
        saveCurrentAnswer();
        if (currentQuestionIndex > 0) {
            showQuestion(currentQuestionIndex - 1);
        }
    }

    function saveCurrentAnswer() {
      const currentSlide = document.querySelector('.question-slide[style*="block"]');
      if (!currentSlide) return;

      const questionId = currentSlide.dataset.questionId;

      // Save QCM answer
      const radioInput = currentSlide.querySelector('input[type="radio"]:checked');
      if (radioInput) {
          studentAnswers[questionId] = radioInput.value;
          console.log(`Saved QCM answer for question ${questionId}:`, radioInput.value);
      }

      // Save dictée answer - IMPROVED
      const textArea = currentSlide.querySelector('textarea[name^="question_"]');
      if (textArea) {
          const answerText = textArea.value.trim();
          studentAnswers[questionId] = answerText;
          console.log(`Saved dictée answer for question ${questionId}:`, answerText);
          console.log(`Answer length: ${answerText.length} characters`);
      }

      // Save fill-in-the-blanks answers
      const fillBlankInputs = currentSlide.querySelectorAll('.fill-blank-input');
      if (fillBlankInputs.length > 0) {
          const blankAnswers = [];
          fillBlankInputs.forEach((input, index) => {
              blankAnswers.push(input.value.trim());
          });
          studentAnswers[questionId] = blankAnswers;
          console.log(`Saved fill-in-blanks answers for question ${questionId}:`, blankAnswers);
      }

      console.log('Current studentAnswers:', studentAnswers);
  }

    function submitExercise() {
        saveCurrentAnswer();

        console.log('Submitting answers:', studentAnswers);

        // Check if we have any answers
        if (Object.keys(studentAnswers).length === 0) {
            alert('Aucune réponse détectée. Veuillez vérifier vos réponses.');
            return;
        }

        // Submit answers to server
        fetch("{% url 'submit_exercise' exercise.pk %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}',
            },
            body: JSON.stringify(studentAnswers)
        })
        .then(response => {
            console.log('Response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Server response:', data);
            if (data.success) {
                showResults(data);
            } else {
                alert('Erreur: ' + (data.error || 'Erreur inconnue'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Une erreur est survenue lors de la soumission.');
        });
    }

    function showResults(data) {
        document.getElementById('exerciseInterface').style.display = 'none';
        document.getElementById('resultsSection').style.display = 'block';

        // Update score display
        document.getElementById('scoreDisplay').textContent = data.score_percentage + '%';
        document.getElementById('correctDisplay').textContent = data.correct_answers;
        document.getElementById('totalDisplay').textContent = data.total_questions;

        // Show detailed results
        const detailedContainer = document.getElementById('detailedResults');
        let resultsHTML = '';

        data.results.forEach((result, index) => {
            const statusClass = result.is_correct ? 'success' : 'danger';
            const statusIcon = result.is_correct ? 'check' : 'times';

            resultsHTML += `
                <div class="card mb-3 border-${statusClass}">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-${statusIcon} text-${statusClass} me-2"></i>
                            Question ${index + 1}
                        </h5>
                        <p><strong>Votre réponse:</strong> ${result.submitted_answer || 'Aucune réponse'}</p>
                        <p><strong>Réponse correcte:</strong> ${result.correct_answer}</p>
                        ${result.explanation ? `<p><strong>Explication:</strong> ${result.explanation}</p>` : ''}
                    </div>
                </div>
            `;
        });

        detailedContainer.innerHTML = resultsHTML;

        // ADD THIS: Auto-redirect after a delay to refresh the topic page
        setTimeout(() => {
            const topicUrl = document.querySelector('a[href*="student_topic_detail"]').href;
            if (topicUrl) {
                window.location.href = topicUrl;
            }
        }, 5000); // Redirect after 5 seconds
    }

    function toggleHint(questionId) {
        const hint = document.getElementById('hint_' + questionId);
        hint.style.display = hint.style.display === 'none' ? 'block' : 'none';
    }

    // Enhanced dictée functions with word-by-word speech
    function playDictation(text, questionId) {
        playDictationWordByWord(text, questionId, 0.6, 1500); // Normal speed with 1.5s pauses
    }

    function playSlowDictation(text, questionId) {
        playDictationWordByWord(text, questionId, 0.4, 2500); // Slow speed with 2.5s pauses
    }

    function playDictationWordByWord(text, questionId, speed, pauseDuration) {
        if ('speechSynthesis' in window) {
            // Stop any ongoing speech
            stopDictation();

            // Show progress indicator
            const progressDiv = document.getElementById(`speechProgress_${questionId}`);
            const statusSpan = document.getElementById(`speechStatus_${questionId}`);
            const playBtn = document.getElementById(`playDictationBtn_${questionId}`);

            if (progressDiv && statusSpan && playBtn) {
                progressDiv.style.display = 'block';
                statusSpan.textContent = speed <= 0.4 ? 'Dictée lente en cours...' : 'Dictée en cours...';
                playBtn.disabled = true;
                playBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>En cours...';
            }

            // Clean and split text into words
            const cleanText = text.replace(/[.,!?;:]/g, '').trim();
            const words = cleanText.split(/\s+/).filter(word => word.length > 0);

            let currentWordIndex = 0;
            let isPlaying = true;

            function speakNextWord() {
                if (!isPlaying || currentWordIndex >= words.length) {
                    // Finished or stopped
                    finishDictation();
                    return;
                }

                const word = words[currentWordIndex];

                // Update status to show current word
                if (statusSpan) {
                    statusSpan.innerHTML = `
                        <strong>Mot ${currentWordIndex + 1}/${words.length}:</strong> "${word}"
                        <br><small>Pause de ${pauseDuration/1000}s après chaque mot...</small>
                    `;
                }

                const utterance = new SpeechSynthesisUtterance(word);

                // Configure speech settings
                utterance.lang = 'fr-FR';
                utterance.rate = speed;
                utterance.pitch = 1.0;
                utterance.volume = 0.9;

                // Try to use a French voice if available
                const voices = speechSynthesis.getVoices();
                const frenchVoice = voices.find(voice =>
                    voice.lang.startsWith('fr') && voice.name.includes('Female')
                ) || voices.find(voice => voice.lang.startsWith('fr'));

                if (frenchVoice) {
                    utterance.voice = frenchVoice;
                }

                // Set up event handlers
                utterance.onend = function() {
                    if (isPlaying) {
                        currentWordIndex++;

                        // Show pause indicator
                        if (statusSpan && currentWordIndex < words.length) {
                            statusSpan.innerHTML = `
                                <i class="fas fa-clock me-1"></i>
                                Pause... Prochain mot: "${words[currentWordIndex]}" dans ${pauseDuration/1000}s
                            `;
                        }

                        // Wait before speaking next word
                        setTimeout(() => {
                            if (isPlaying) {
                                speakNextWord();
                            }
                        }, pauseDuration);
                    } else {
                        finishDictation();
                    }
                };

                utterance.onerror = function(e) {
                    console.error('Speech synthesis error:', e);
                    finishDictation();
                    alert('Erreur lors de la lecture audio. Vérifiez vos paramètres.');
                };

                // Store reference and speak
                currentUtterance = utterance;
                speechSynthesis.speak(utterance);
            }

            function finishDictation() {
                isPlaying = false;
                if (progressDiv && playBtn && statusSpan) {
                    progressDiv.style.display = 'none';
                    playBtn.disabled = false;
                    playBtn.innerHTML = '<i class="fas fa-play me-2"></i>Écouter la dictée';
                }
                currentUtterance = null;
            }

            // Override the stop function for this session
            window.currentDictationStopper = function() {
                isPlaying = false;
                speechSynthesis.cancel();
                finishDictation();
            };

            // Start the word-by-word dictation
            speakNextWord();

        } else {
            alert('La synthèse vocale n\'est pas supportée par votre navigateur.');
        }
    }

    function stopDictation() {
        // Call the current session stopper if it exists
        if (window.currentDictationStopper) {
            window.currentDictationStopper();
            window.currentDictationStopper = null;
        }

        if (speechSynthesis.speaking) {
            speechSynthesis.cancel();
        }

        // Reset all progress indicators
        document.querySelectorAll('[id^="speechProgress_"]').forEach(div => {
            div.style.display = 'none';
        });

        document.querySelectorAll('[id^="playDictationBtn_"]').forEach(btn => {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-play me-2"></i>Écouter la dictée';
        });

        currentUtterance = null;
    }

    // Add new function for sentence-by-sentence dictation (alternative)
    function playSentenceDictation(text, questionId) {
        if ('speechSynthesis' in window) {
            stopDictation();

            // Show progress
            const progressDiv = document.getElementById(`speechProgress_${questionId}`);
            const statusSpan = document.getElementById(`speechStatus_${questionId}`);
            const playBtn = document.getElementById(`playDictationBtn_${questionId}`);

            if (progressDiv && statusSpan && playBtn) {
                progressDiv.style.display = 'block';
                statusSpan.textContent = 'Lecture phrase par phrase...';
                playBtn.disabled = true;
                playBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>En cours...';
            }

            // Split into sentences
            const sentences = text.split(/[.!?]+/).filter(s => s.trim().length > 0);
            let currentSentenceIndex = 0;
            let isPlaying = true;

            function speakNextSentence() {
                if (!isPlaying || currentSentenceIndex >= sentences.length) {
                    finishSentenceDictation();
                    return;
                }

                const sentence = sentences[currentSentenceIndex].trim() + '.';

                if (statusSpan) {
                    statusSpan.innerHTML = `
                        <strong>Phrase ${currentSentenceIndex + 1}/${sentences.length}</strong>
                        <br><small>Pause de 3 secondes entre les phrases...</small>
                    `;
                }

                const utterance = new SpeechSynthesisUtterance(sentence);
                utterance.lang = 'fr-FR';
                utterance.rate = 0.5;
                utterance.pitch = 1.0;
                utterance.volume = 0.9;

                const voices = speechSynthesis.getVoices();
                const frenchVoice = voices.find(voice => voice.lang.startsWith('fr'));
                if (frenchVoice) {
                    utterance.voice = frenchVoice;
                }

                utterance.onend = function() {
                    if (isPlaying) {
                        currentSentenceIndex++;
                        setTimeout(() => {
                            if (isPlaying) speakNextSentence();
                        }, 3000); // 3 second pause between sentences
                    }
                };

                speechSynthesis.speak(utterance);
            }

            function finishSentenceDictation() {
                isPlaying = false;
                if (progressDiv && playBtn) {
                    progressDiv.style.display = 'none';
                    playBtn.disabled = false;
                    playBtn.innerHTML = '<i class="fas fa-play me-2"></i>Écouter la dictée';
                }
            }

            speakNextSentence();
        }
    }

    // Character counter for dictée - ADD THIS TO THE EXISTING SCRIPT
    document.addEventListener('DOMContentLoaded', function() {
        // Add character counters to dictée textareas
        document.querySelectorAll('[id^="dicteeAnswer_"]').forEach(textarea => {
            const questionId = textarea.id.split('_')[1];
            const charCountSpan = document.getElementById(`charCount_${questionId}`);

            if (charCountSpan) {
                // Update counter on input
                textarea.addEventListener('input', function() {
                    charCountSpan.textContent = this.value.length;
                });

                // Initial count
                charCountSpan.textContent = textarea.value.length;
            }
        });

        // Load voices when they become available
        if ('speechSynthesis' in window) {
            speechSynthesis.onvoiceschanged = function() {
                console.log('Voices loaded:', speechSynthesis.getVoices().length);
            };
        }
    });

    function updateCharCount(questionId) {
      const textarea = document.getElementById(`dicteeAnswer_${questionId}`);
      const charCount = document.getElementById(`charCount_${questionId}`);

      if (textarea && charCount) {
          charCount.textContent = textarea.value.length;

          // Visual feedback
          if (textarea.value.length > 0) {
              textarea.style.borderColor = '#28a745'; // Green border when typing
          } else {
              textarea.style.borderColor = '#ced4da'; // Default border when empty
          }
      }
  }
</script>
{% endblock %}
