{% extends 'base/base.html' %}
{% load static %}

{% block title %}Voice Assessment - EduKids{% endblock %}

{% block extra_css %}
<style>
    .recording-section {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 15px;
        padding: 30px;
        color: white;
        margin: 20px 0;
    }
    
    .recording-controls {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 20px;
        flex-wrap: wrap;
    }
    
    .btn-record {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        border: none;
        font-size: 24px;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    
    .btn-record:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 20px rgba(0,0,0,0.3);
    }
    
    .btn-record.recording {
        background: #dc3545;
        animation: pulse 1.5s infinite;
    }
    
    .btn-record:not(.recording) {
        background: #28a745;
    }
    
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.1); }
        100% { transform: scale(1); }
    }
    
    .waveform {
        height: 60px;
        background: rgba(255,255,255,0.1);
        border-radius: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 20px 0;
    }
    
    .waveform.active {
        background: rgba(255,255,255,0.2);
    }
    
    .waveform-bar {
        width: 4px;
        background: #fff;
        margin: 0 2px;
        border-radius: 2px;
        animation: wave 1s ease-in-out infinite;
    }
    
    @keyframes wave {
        0%, 100% { height: 20px; }
        50% { height: 40px; }
    }
    
    .recording-status {
        text-align: center;
        margin: 20px 0;
        font-size: 18px;
        font-weight: 500;
    }
    
    .recording-timer {
        font-size: 24px;
        font-weight: bold;
        color: #fff;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    
    .exercise-prompt {
        background: #f8f9fa;
        border: 2px solid #e9ecef;
        border-radius: 10px;
        padding: 20px;
        margin: 20px 0;
    }
    
    .exercise-prompt h5 {
        color: #007bff;
        margin-bottom: 15px;
    }
    
    .exercise-prompt p {
        color: #2c3e50;
        font-size: 16px;
        line-height: 1.6;
        font-weight: 500;
    }
    
    .exercise-prompt .question-text {
        color: #2c3e50;
        font-size: 18px;
        line-height: 1.6;
        font-weight: 600;
        text-align: center;
        padding: 15px;
        background: #ffffff;
        border-radius: 8px;
        border: 2px solid #e9ecef;
    }
    
    .language-selector {
        margin: 20px 0;
    }
    
    .language-btn {
        margin: 5px;
        padding: 10px 20px;
        border: 2px solid #007bff;
        background: white;
        color: #007bff;
        border-radius: 25px;
        transition: all 0.3s ease;
    }
    
    .language-btn.active {
        background: #007bff;
        color: white;
    }
    
    .language-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .results-section {
        background: white;
        border-radius: 15px;
        padding: 30px;
        margin: 20px 0;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .score-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 20px;
        margin: 10px 0;
        text-align: center;
    }
    
    .score-number {
        font-size: 48px;
        font-weight: bold;
        margin: 10px 0;
    }
    
    .grade-badge {
        font-size: 24px;
        font-weight: bold;
        padding: 10px 20px;
        border-radius: 25px;
        margin: 10px 0;
    }
    
    .grade-A { background: #28a745; color: white; }
    .grade-B { background: #17a2b8; color: white; }
    .grade-C { background: #ffc107; color: black; }
    .grade-D { background: #fd7e14; color: white; }
    .grade-F { background: #dc3545; color: white; }
    
    .analysis-details {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin: 20px 0;
    }
    
    .strength-item, .improvement-item {
        padding: 10px;
        margin: 5px 0;
        border-radius: 5px;
        border-left: 4px solid #007bff;
    }
    
    .strength-item {
        background: #d1ecf1;
        border-left-color: #17a2b8;
        border-radius: 8px;
        margin: 5px 0;
        padding: 10px;
        font-weight: 500;
        color: #0c5460;
    }
    
    .improvement-item {
        background: #f8d7da;
        border-left-color: #dc3545;
        border-radius: 8px;
        margin: 5px 0;
        padding: 10px;
        font-weight: 500;
        color: #721c24;
    }
    
    .recommendations {
        background: #f8f9fa;
        border: 2px solid #007bff;
        border-radius: 10px;
        padding: 20px;
        margin: 20px 0;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .recommendations h6 {
        color: #007bff !important;
        font-weight: bold;
    }
    
    .recommendations ul li {
        color: #1a1a1a !important;
        font-weight: 600;
        font-size: 16px;
        line-height: 1.6;
        margin: 8px 0;
        padding: 10px;
        background: #ffffff;
        border-radius: 8px;
        border-left: 4px solid #007bff;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #007bff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .hidden {
        display: none !important;
    }
    
    .fade-in {
        animation: fadeIn 0.5s ease-in;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>
{% endblock %}

{% block content %}
{% csrf_token %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card shadow-lg border-0">
                <div class="card-header bg-primary text-white text-center py-4">
                    <h2 class="mb-0">
                        <i class="fas fa-microphone-alt me-3"></i>
                        Voice Assessment - AI Teacher
                    </h2>
                    <p class="mb-0 mt-2">Get evaluated by our AI teacher for your speaking skills</p>
                </div>
                
                <div class="card-body p-4">
                    <!-- Language Selection -->
                    <div class="language-selector text-center mb-4">
                        <h5 class="mb-3">Choose your language:</h5>
                        <div class="d-flex justify-content-center flex-wrap">
                            <button class="btn language-btn active" data-lang="french">
                                <i class="fas fa-flag me-2"></i>Fran√ßais
                            </button>
                            <button class="btn language-btn" data-lang="english">
                                <i class="fas fa-flag me-2"></i>English
                            </button>
                            <button class="btn language-btn" data-lang="arabic">
                                <i class="fas fa-flag me-2"></i>ÿßŸÑÿπÿ±ÿ®Ÿäÿ©
                            </button>
                        </div>
                    </div>
                    
                    <!-- Exercise Prompt -->
                    <div id="exercisePrompt" class="exercise-prompt">
                        <div class="text-center">
                            <h5 class="text-muted">Please select a language first</h5>
                        </div>
                    </div>
                    
                    <!-- Real-time Transcription Display -->
                    <div class="mb-4">
                        <h5 class="fw-bold mb-3">
                            <i class="fas fa-comments text-primary me-2"></i>Real-time Transcription Display
                        </h5>
                        <div class="card border-0 bg-light">
                            <div class="card-body">
                                <div id="realtimeTranscription" class="min-height-100" style="min-height: 100px; font-size: 1.1rem; line-height: 1.6;">
                                    <span class="text-muted">Parlez et voyez vos mots appara√Ætre ici en temps r√©el...</span>
                                </div>
                                <div class="mt-2">
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Parlez clairement en <span id="selectedLanguage">Fran√ßais</span> pour une √©valuation pr√©cise
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Recording Interface -->
                    <div class="recording-section mb-4">
                        <div class="text-center">
                            <div class="recording-controls mb-3">
                                <button id="recordBtn" class="btn btn-record" disabled>
                                    <i class="fas fa-microphone"></i>
                                </button>
                                <button id="playBtn" class="btn btn-success" disabled>
                                    <i class="fas fa-play"></i>
                                </button>
                                <button id="stopPlaybackBtn" class="btn btn-warning" disabled>
                                    <i class="fas fa-stop"></i>
                                </button>
                            </div>
                            
                            <div class="waveform" id="waveform">
                                <div class="waveform-bar"></div>
                                <div class="waveform-bar"></div>
                                <div class="waveform-bar"></div>
                                <div class="waveform-bar"></div>
                                <div class="waveform-bar"></div>
                            </div>
                            
                            <div class="recording-status" id="recordingStatus">
                                Ready to record
                            </div>
                            
                            <div class="recording-timer" id="recordingTimer" style="display: none;">
                                00:00
                            </div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="text-center mb-4">
                        <button id="generateExerciseBtn" class="btn btn-primary btn-lg me-3">
                            <i class="fas fa-plus me-2"></i>Generate New Exercise
                        </button>
                        <button id="submitBtn" class="btn btn-success btn-lg" disabled>
                            <i class="fas fa-robot me-2"></i>Submit for AI Teacher Evaluation
                        </button>
                    </div>
                    
                    <!-- Results Section -->
                    <div id="resultsSection" class="results-section hidden">
                        <h4 class="text-center mb-4">
                            <i class="fas fa-chart-line me-2"></i>AI Teacher Evaluation Results
                        </h4>
                        
                        <div class="row">
                            <div class="col-md-3">
                                <div class="score-card">
                                    <h5>Overall Score</h5>
                                    <div class="score-number" id="overallScore">0</div>
                                    <div class="grade-badge" id="gradeBadge">-</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="score-card">
                                    <h5>Language Level</h5>
                                    <div class="score-number" id="languageLevel">-</div>
                                    <div class="grade-badge" id="levelBadge">-</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="score-card">
                                    <h5>Performance</h5>
                                    <div class="score-number" id="performanceLevel">Average</div>
                                    <div class="grade-badge" id="performanceBadge">-</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="score-card">
                                    <h5>Originality</h5>
                                    <div class="score-number" id="originalityScore">0%</div>
                                    <div class="grade-badge" id="originalityBadge">-</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Detailed Analysis Section -->
                        <div id="detailedAnalysis"></div>
                        
                        <div class="analysis-details">
                            <h5 class="mb-3">Detailed Analysis</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="text-primary"><i class="fas fa-comments me-2"></i>Verbal Communication</h6>
                                    <ul class="list-group">
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            <span><i class="fas fa-sitemap me-2 text-primary"></i>Structure</span>
                                            <span class="badge bg-primary text-white fw-bold" id="structureScore">0%</span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            <span><i class="fas fa-tachometer-alt me-2 text-success"></i>Fluency</span>
                                            <span class="badge bg-success text-white fw-bold" id="fluencyScore">0%</span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            <span><i class="fas fa-book me-2 text-info"></i>Vocabulary</span>
                                            <span class="badge bg-info text-white fw-bold" id="vocabularyScore">0%</span>
                                        </li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-warning"><i class="fas fa-music me-2"></i>Paraverbal Communication</h6>
                                    <ul class="list-group">
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            <span><i class="fas fa-wave-square me-2 text-warning"></i>Intonation</span>
                                            <span class="badge bg-warning text-dark fw-bold" id="intonationScore">0%</span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            <span><i class="fas fa-clock me-2 text-secondary"></i>Rhythm</span>
                                            <span class="badge bg-secondary text-white fw-bold" id="rhythmScore">0%</span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            <span><i class="fas fa-stopwatch me-2 text-dark"></i>Timing</span>
                                            <span class="badge bg-dark text-white fw-bold" id="timingScore">0%</span>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mt-4">
                            <div class="col-md-6">
                                <h6 class="text-success fw-bold"><i class="fas fa-thumbs-up me-2"></i>Strengths</h6>
                                <ul id="strengthsList" class="list-unstyled">
                                    <!-- Strengths will be populated here -->
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-warning fw-bold"><i class="fas fa-exclamation-triangle me-2"></i>Areas for Improvement</h6>
                                <ul id="improvementsList" class="list-unstyled">
                                    <!-- Improvements will be populated here -->
                                </ul>
                            </div>
                        </div>
                        
                        <div class="recommendations">
                            <h6 class="text-primary fw-bold"><i class="fas fa-robot me-2"></i>AI Teacher Recommendations</h6>
                            <div id="recommendationsList">
                                <!-- Recommendations will be populated here -->
                            </div>
                        </div>
                        
                        <!-- Transcription Used for Analysis -->
                        <div class="mt-4">
                            <div class="alert alert-light border">
                                <h6 class="text-info">
                                    <i class="fas fa-file-text me-2"></i>Transcription Used for Analysis
                                </h6>
                                <div id="transcriptionUsed" class="mb-2">
                                    <!-- Transcription will be shown here -->
                                </div>
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    This transcription was analyzed by AI to generate the scores above
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
class SimpleVoiceAssessment {
    constructor() {
        this.isRecording = false;
        this.mediaRecorder = null;
        this.audioChunks = [];
        this.recordedAudio = null;
        this.currentLanguage = 'english';
        this.currentExercise = null;
        this.startTime = null;
        this.recordingTimer = null;
        this.speechRecognition = null;
        this.transcriptionText = '';
        
        this.initializeElements();
        this.setupEventListeners();
    }
    
    initializeElements() {
        this.recordBtn = document.getElementById('recordBtn');
        this.playBtn = document.getElementById('playBtn');
        this.stopPlaybackBtn = document.getElementById('stopPlaybackBtn');
        this.generateExerciseBtn = document.getElementById('generateExerciseBtn');
        this.submitBtn = document.getElementById('submitBtn');
        this.exercisePrompt = document.getElementById('exercisePrompt');
        this.recordingStatus = document.getElementById('recordingStatus');
        this.recordingTimer = document.getElementById('recordingTimer');
        this.waveform = document.getElementById('waveform');
        this.resultsSection = document.getElementById('resultsSection');
        this.realtimeTranscription = document.getElementById('realtimeTranscription');
        this.selectedLanguage = document.getElementById('selectedLanguage');
    }
    
    setupEventListeners() {
        // Language selection
        document.querySelectorAll('.language-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.language-btn').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                this.currentLanguage = e.target.dataset.lang;
                
                // Update language display
                const languageNames = {
                    'french': 'Fran√ßais',
                    'english': 'English',
                    'arabic': 'ÿßŸÑÿπÿ±ÿ®Ÿäÿ©'
                };
                this.selectedLanguage.textContent = languageNames[this.currentLanguage];
                
                this.generateNewExercise();
            });
        });
        
        // Recording controls
        this.recordBtn.addEventListener('click', () => this.toggleRecording());
        this.playBtn.addEventListener('click', () => this.playRecording());
        this.stopPlaybackBtn.addEventListener('click', () => this.stopPlayback());
        
        // Exercise generation
        this.generateExerciseBtn.addEventListener('click', () => this.generateNewExercise());
        
        // Submit for analysis
        this.submitBtn.addEventListener('click', () => this.submitAssessment());
    }
    
    generateNewExercise() {
        console.log('üéØ Generating new exercise...');
        
        const exercises = {
            'french': [
                {
                    title: "üéØ L'aventure magique",
                    prompt: "Imaginez que vous d√©couvrez une porte magique dans votre jardin. Que se passe-t-il quand vous l'ouvrez ? Racontez votre aventure en 2-3 minutes. Soyez cr√©atif et utilisez des mots descriptifs !",
                    duration: "2-3",
                    difficulty: "B1-B2"
                },
                {
                    title: "üéØ Le voyage dans le temps",
                    prompt: "Vous avez une machine √† voyager dans le temps. √Ä quelle √©poque iriez-vous et pourquoi ? D√©crivez ce que vous feriez l√†-bas en 2-3 minutes.",
                    duration: "2-3",
                    difficulty: "A2-B1"
                },
                {
                    title: "üéØLe super-pouvoir",
                    prompt: "Si vous pouviez avoir n'importe quel super-pouvoir, lequel choisiriez-vous ? Comment l'utiliseriez-vous dans votre vie quotidienne ? Parlez pendant 2-3 minutes.",
                    duration: "2-3",
                    difficulty: "A1-A2"
                }
            ],
            'english': [
                {
                    title: "üéØThe Magical Adventure",
                    prompt: "Imagine you discover a magical door in your backyard. What happens when you open it? Tell us about your adventure in 2-3 minutes. Be creative and use descriptive words!",
                    duration: "2-3",
                    difficulty: "B1-B2"
                },
                {
                    title: "üéØTime Travel",
                    prompt: "You have a time machine. What era would you visit and why? Describe what you would do there in 2-3 minutes.",
                    duration: "2-3",
                    difficulty: "A2-B1"
                },
                {
                    title: "üéØSuper Power",
                    prompt: "If you could have any superpower, which would you choose? How would you use it in your daily life? Speak for 2-3 minutes.",
                    duration: "2-3",
                    difficulty: "A1-A2"
                }
            ],
            'arabic': [
                {
                    title: "üéØÿßŸÑŸÖÿ∫ÿßŸÖÿ±ÿ© ÿßŸÑÿ≥ÿ≠ÿ±Ÿäÿ©",
                    prompt: "ÿ™ÿÆŸäŸÑ ÿ£ŸÜŸÉ ÿ™ŸÉÿ™ÿ¥ŸÅ ÿ®ÿßÿ®ÿßŸã ÿ≥ÿ≠ÿ±ŸäÿßŸã ŸÅŸä ÿ≠ÿØŸäŸÇÿ™ŸÉ. ŸÖÿßÿ∞ÿß Ÿäÿ≠ÿØÿ´ ÿπŸÜÿØŸÖÿß ÿ™ŸÅÿ™ÿ≠Ÿáÿü ÿßÿ±Ÿà ŸÑŸÜÿß ŸÖÿ∫ÿßŸÖÿ±ÿ™ŸÉ ŸÅŸä 2-3 ÿØŸÇÿßÿ¶ŸÇ. ŸÉŸÜ ŸÖÿ®ÿØÿπÿßŸã Ÿàÿßÿ≥ÿ™ÿÆÿØŸÖ ŸÉŸÑŸÖÿßÿ™ ŸàÿµŸÅŸäÿ©!",
                    duration: "2-3",
                    difficulty: "B1-B2"
                },
                {
                    title: "üéØÿßŸÑÿ≥ŸÅÿ± ÿπÿ®ÿ± ÿßŸÑÿ≤ŸÖŸÜ",
                    prompt: "ŸÑÿØŸäŸÉ ÿ¢ŸÑÿ© ŸÑŸÑÿ≥ŸÅÿ± ÿπÿ®ÿ± ÿßŸÑÿ≤ŸÖŸÜ. ÿ•ŸÑŸâ ÿ£Ÿä ÿπÿµÿ± ÿ≥ÿ™ÿ∞Ÿáÿ® ŸàŸÑŸÖÿßÿ∞ÿßÿü ÿµŸÅ ŸÖÿß ÿ≥ÿ™ŸÅÿπŸÑŸá ŸáŸÜÿßŸÉ ŸÅŸä 2-3 ÿØŸÇÿßÿ¶ŸÇ.",
                    duration: "2-3",
                    difficulty: "A2-B1"
                },
                {
                    title: "üéØÿßŸÑŸÇŸàÿ© ÿßŸÑÿÆÿßÿ±ŸÇÿ©",
                    prompt: "ŸÑŸà ŸÉÿßŸÜ ÿ®ÿ•ŸÖŸÉÿßŸÜŸÉ ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿ£Ÿä ŸÇŸàÿ© ÿÆÿßÿ±ŸÇÿ©ÿå ÿ£Ÿä Ÿàÿßÿ≠ÿØÿ© ÿ≥ÿ™ÿÆÿ™ÿßÿ±ÿü ŸÉŸäŸÅ ÿ≥ÿ™ÿ≥ÿ™ÿÆÿØŸÖŸáÿß ŸÅŸä ÿ≠Ÿäÿßÿ™ŸÉ ÿßŸÑŸäŸàŸÖŸäÿ©ÿü ÿ™ÿ≠ÿØÿ´ ŸÑŸÖÿØÿ© 2-3 ÿØŸÇÿßÿ¶ŸÇ.",
                    duration: "2-3",
                    difficulty: "A1-A2"
                }
            ]
        };
        
        const languageExercises = exercises[this.currentLanguage] || exercises['french'];
        const exercise = languageExercises[Math.floor(Math.random() * languageExercises.length)];
        
        this.currentExercise = exercise;
        
        this.exercisePrompt.innerHTML = `
            <h5 class="fw-bold mb-3">${exercise.title}</h5>
            <p class="mb-3">${exercise.prompt}</p>
            <div class="alert alert-info">
                <i class="fas fa-clock me-2"></i>
                <strong>Duration:</strong> ${exercise.duration} minutes
            </div>
        `;
        
        this.recordBtn.disabled = false;
        console.log('‚úÖ Exercise generated:', exercise.title);
    }
    
    async toggleRecording() {
        if (!this.isRecording) {
            await this.startRecording();
        } else {
            this.stopRecording();
        }
    }
    
    async startRecording() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            // Forcer le format audio compatible avec AssemblyAI
            let options = { mimeType: 'audio/webm;codecs=opus' };
            
            // V√©rifier si le format est support√©
            if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                options = { mimeType: 'audio/webm' };
                console.log('‚ö†Ô∏è Format opus non support√©, utilisation audio/webm');
            }
            
            if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                options = { mimeType: 'audio/mp4' };
                console.log('‚ö†Ô∏è Format webm non support√©, utilisation audio/mp4');
            }
            
            this.mediaRecorder = new MediaRecorder(stream, options);
            this.audioChunks = [];
            
            console.log('üé§ Format audio:', this.mediaRecorder.mimeType);
            
            this.mediaRecorder.ondataavailable = (event) => {
                if (event.data.size > 0) {
                    this.audioChunks.push(event.data);
                    console.log('üì¶ Chunk audio ajout√©:', event.data.size, 'bytes');
                }
            };
            
            this.mediaRecorder.onstop = () => {
                // Cr√©er un blob audio compatible avec AssemblyAI
                const mimeType = this.mediaRecorder.mimeType || 'audio/webm';
                const audioBlob = new Blob(this.audioChunks, { type: mimeType });
                this.recordedAudio = audioBlob;
                this.playBtn.disabled = false;
                this.submitBtn.disabled = false;
                console.log('‚úÖ Recording completed');
                console.log('üìä Audio blob:', {
                    size: audioBlob.size,
                    type: audioBlob.type,
                    chunks: this.audioChunks.length
                });
            };
            
            this.mediaRecorder.start();
            this.isRecording = true;
            this.startTime = Date.now();
            
            this.recordBtn.classList.add('recording');
            this.recordBtn.innerHTML = '<i class="fas fa-stop"></i>';
            this.recordingStatus.textContent = 'Recording...';
            this.recordingTimer.style.display = 'block';
            this.waveform.classList.add('active');
            
            this.startTimer();
            this.animateWaveform();
            
            // Start real-time transcription
            this.startRealtimeTranscription();
            
        } catch (error) {
            console.error('Error accessing microphone:', error);
            alert('Please allow microphone access to use voice assessment.');
        }
    }
    
    stopRecording() {
        if (this.mediaRecorder && this.isRecording) {
            this.mediaRecorder.stop();
            this.isRecording = false;
            
            this.recordBtn.classList.remove('recording');
            this.recordBtn.innerHTML = '<i class="fas fa-microphone"></i>';
            this.recordingStatus.textContent = 'Recording completed';
            this.waveform.classList.remove('active');
            
            this.stopTimer();
            this.stopWaveform();
            
            // Stop real-time transcription
            this.stopRealtimeTranscription();
        }
    }
    
    playRecording() {
        if (this.recordedAudio) {
            const audio = new Audio(URL.createObjectURL(this.recordedAudio));
            audio.play();
            
            this.playBtn.disabled = true;
            this.stopPlaybackBtn.disabled = false;
            
            audio.onended = () => {
                this.playBtn.disabled = false;
                this.stopPlaybackBtn.disabled = true;
            };
        }
    }
    
    stopPlayback() {
        // Stop any playing audio
        const audioElements = document.querySelectorAll('audio');
        audioElements.forEach(audio => audio.pause());
        
        this.playBtn.disabled = false;
        this.stopPlaybackBtn.disabled = true;
    }
    
    startTimer() {
        this.recordingTimer = setInterval(() => {
            const elapsed = Math.floor((Date.now() - this.startTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            document.getElementById('recordingTimer').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }, 1000);
    }
    
    stopTimer() {
        if (this.recordingTimer) {
            clearInterval(this.recordingTimer);
            this.recordingTimer = null;
        }
    }
    
    animateWaveform() {
        const bars = this.waveform.querySelectorAll('.waveform-bar');
        bars.forEach((bar, index) => {
            bar.style.animationDelay = `${index * 0.1}s`;
        });
    }
    
    stopWaveform() {
        const bars = this.waveform.querySelectorAll('.waveform-bar');
        bars.forEach(bar => {
            bar.style.animation = 'none';
        });
    }
    
    async submitAssessment() {
        if (!this.recordedAudio) {
            alert('Please record your response first.');
            return;
        }
        
        this.submitBtn.innerHTML = '<span class="loading-spinner"></span> Analyzing with AssemblyAI...';
        this.submitBtn.disabled = true;
        
        try {
            // Step 1: Get REAL AssemblyAI transcription
            console.log('üé§ Step 1: Getting REAL AssemblyAI transcription...');
            
            this.realtimeTranscription.innerHTML = `
                <div class="alert alert-info">
                    <h6><i class="fas fa-spinner fa-spin me-2"></i>Transcription AssemblyAI en cours...</h6>
                    <p class="mb-2">Envoi de votre audio vers AssemblyAI...</p>
                    <div class="progress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 50%"></div>
                    </div>
                </div>
            `;
            
            // Call AssemblyAI API through Django backend
            const formData = new FormData();
            formData.append('audio', this.recordedAudio, 'recording.wav');
            formData.append('prompt', this.currentExercise.prompt);
            formData.append('student_id', '1');
            
            console.log('üì§ Sending audio to AssemblyAI via Django backend...');
            
            // Call the voice-audio-only API which uses AssemblyAI
            const response = await fetch('/assessments/api/voice-assessment-audio-analyze/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const analysis = await response.json();
            console.log('‚úÖ AssemblyAI transcription + analysis received:', analysis);
            
            // Step 2: Display the REAL transcription
            this.transcriptionText = analysis.transcription || '[Transcription non disponible]';
            
            this.realtimeTranscription.innerHTML = `
                <div class="alert alert-success">
                    <h6><i class="fas fa-check-circle me-2"></i>Transcription AssemblyAI R√âELLE</h6>
                    <p class="mb-3"><strong>Ce que vous avez dit:</strong></p>
                    <div class="bg-white p-3 rounded border" style="font-size: 1.2rem;">
                        "${this.transcriptionText}"
                    </div>
                    <div class="mt-2">
                        <small class="text-success">
                            <i class="fas fa-check me-1"></i>
                            Transcription valid√©e par AssemblyAI
                        </small>
                    </div>
                </div>
            `;
            
            // Step 3: Display the REAL analysis results
            console.log('üìä Displaying REAL analysis results...');
            this.displayRealResults(analysis);
            
        } catch (error) {
            console.error('‚ùå Error with AssemblyAI analysis:', error);
            
            this.realtimeTranscription.innerHTML = `
                <div class="alert alert-danger">
                    <h6><i class="fas fa-exclamation-triangle me-2"></i>Erreur AssemblyAI</h6>
                    <p class="mb-2">Impossible de transcrire l'audio. Erreur: ${error.message}</p>
                    <small class="text-muted">Veuillez r√©essayer.</small>
                </div>
            `;
            
            this.submitBtn.innerHTML = '<i class="fas fa-robot me-2"></i>Submit for AI Teacher Evaluation';
            this.submitBtn.disabled = false;
        }
    }
    
    async getRealTranscription() {
        try {
            const formData = new FormData();
            formData.append('audio', this.recordedAudio, 'recording.wav');
            formData.append('language', this.getLanguageCode());
            
            const response = await fetch('/assessments/api/voice-transcription/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            });
            
            if (response.ok) {
                const result = await response.json();
                return result;
            } else {
                return { success: false, error: 'Transcription API failed' };
            }
        } catch (error) {
            console.error('‚ùå Transcription API error:', error);
            return { success: false, error: error.message };
        }
    }
    
    displayRealResults(analysis) {
        console.log('üéØ Displaying REAL analysis results:', analysis);
        
        // Extract real scores from backend
        const overallScore = Math.round(analysis.overall_score || 0);
        const originalityScore = Math.round(analysis.originality_score || 0);
        const structureScore = Math.round(analysis.verbal_structure_score || 0);
        const fluencyScore = Math.round(analysis.verbal_fluency_score || 0);
        const vocabularyScore = Math.round(analysis.verbal_vocabulary_score || 0);
        const intonationScore = Math.round(analysis.paraverbal_intonation_score || 0);
        const rhythmScore = Math.round(analysis.paraverbal_rhythm_score || 0);
        const timingScore = Math.round(analysis.paraverbal_timing_score || 0);
        
        // Convert score to performance level
        const getPerformanceLevel = (score) => {
            if (score >= 90) return 'Excellent';
            if (score >= 80) return 'Very Good';
            if (score >= 70) return 'Good';
            if (score >= 60) return 'Fair';
            if (score >= 50) return 'Average';
            return 'Poor';
        };
        
        // Determine grade based on REAL score
        let grade = 'F';
        if (overallScore >= 90) grade = 'A';
        else if (overallScore >= 80) grade = 'B';
        else if (overallScore >= 70) grade = 'C';
        else if (overallScore >= 60) grade = 'D';
        
        // Use real language level from analysis or determine from score
        const level = this.determineLanguageLevel(overallScore);
        const performanceLevel = getPerformanceLevel(overallScore);
        
        // Update UI with REAL scores - with safety checks
        const updateElement = (id, value, className = null) => {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = value;
                if (className) {
                    element.className = className;
                }
            } else {
                console.warn(`Element with id '${id}' not found`);
            }
        };
        
        updateElement('overallScore', overallScore);
        updateElement('gradeBadge', grade);
        updateElement('gradeBadge', grade, `grade-badge grade-${grade}`);
        updateElement('languageLevel', level);
        updateElement('levelBadge', level);
        updateElement('performanceLevel', performanceLevel);
        updateElement('originalityScore', `${originalityScore}%`);
        
        // Update detailed scores with badges
        updateElement('structureScore', `${structureScore}%`);
        updateElement('fluencyScore', `${fluencyScore}%`);
        updateElement('vocabularyScore', `${vocabularyScore}%`);
        updateElement('intonationScore', `${intonationScore}%`);
        updateElement('rhythmScore', `${rhythmScore}%`);
        updateElement('timingScore', `${timingScore}%`);
        
        // Add detailed analysis information
        this.displayDetailedAnalysis(analysis);
        
        // Generate English feedback based on actual scores
        const strengths = this.generateStrengths(structureScore, fluencyScore, vocabularyScore, intonationScore, rhythmScore, timingScore);
        const improvements = this.generateImprovements(structureScore, fluencyScore, vocabularyScore, intonationScore, rhythmScore, timingScore);
        const recommendations = this.generateRecommendations(structureScore, fluencyScore, vocabularyScore, intonationScore, rhythmScore, timingScore);
        
        // Populate lists with REAL data - with safety checks
        const strengthsList = document.getElementById('strengthsList');
        if (strengthsList) {
            strengthsList.innerHTML = strengths.map(s => `<li class="strength-item">${s}</li>`).join('');
        } else {
            console.warn('Element with id "strengthsList" not found');
        }
        
        const improvementsList = document.getElementById('improvementsList');
        if (improvementsList) {
            improvementsList.innerHTML = improvements.map(i => `<li class="improvement-item">${i}</li>`).join('');
        } else {
            console.warn('Element with id "improvementsList" not found');
        }
        
        const recommendationsList = document.getElementById('recommendationsList');
        if (recommendationsList) {
            recommendationsList.innerHTML = recommendations.map(r => `<li>${r}</li>`).join('');
        } else {
            console.warn('Element with id "recommendationsList" not found');
        }
        
        // Show the transcription used for analysis
        const transcriptionUsed = document.getElementById('transcriptionUsed');
        if (transcriptionUsed) {
            transcriptionUsed.innerHTML = `
                <div class="bg-light p-3 rounded">
                    <strong>Transcription analys√©e:</strong><br>
                    <em>"${this.transcriptionText}"</em>
                </div>
            `;
        }
        
        // Show results - with safety checks
        if (this.resultsSection) {
            this.resultsSection.classList.remove('hidden');
            this.resultsSection.classList.add('fade-in');
        } else {
            console.warn('Results section not found');
        }
        
        // Reset submit button - with safety checks
        if (this.submitBtn) {
            this.submitBtn.innerHTML = '<i class="fas fa-robot me-2"></i>Submit for AI Teacher Evaluation';
            this.submitBtn.disabled = false;
        } else {
            console.warn('Submit button not found');
        }
        
        console.log('‚úÖ REAL results displayed with transcription:', this.transcriptionText);
    }
    
    displayDetailedAnalysis(analysis) {
        // Create detailed analysis section
        const detailedAnalysis = document.getElementById('detailedAnalysis');
        if (detailedAnalysis) {
            detailedAnalysis.innerHTML = `
                <div class="card mb-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Detailed Analysis</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-primary"><i class="fas fa-language me-2"></i>Language Detection</h6>
                                <ul class="list-unstyled">
                                    <li><strong>Prompt Language:</strong> ${analysis.prompt_language || 'English'}</li>
                                    <li><strong>Transcription Language:</strong> ${analysis.transcription_language || 'English'}</li>
                                    <li><strong>Match:</strong> 
                                        <span class="badge ${analysis.language_match ? 'bg-success' : 'bg-danger'}">
                                            ${analysis.language_match ? '‚úÖ YES' : '‚ùå NO'}
                                        </span>
                                    </li>
                                    <li><strong>Match Percentage:</strong> ${analysis.match_percentage || 100}%</li>
                                    <li><strong>Violation Severity:</strong> 
                                        <span class="badge ${analysis.violation_severity === 'low' ? 'bg-success' : analysis.violation_severity === 'medium' ? 'bg-warning' : 'bg-danger'}">
                                            ${analysis.violation_severity || 'low'}
                                        </span>
                                    </li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-warning"><i class="fas fa-shield-alt me-2"></i>Cheating Detection</h6>
                                <ul class="list-unstyled">
                                    <li><strong>Cheating Score:</strong> ${analysis.cheating_score || 0}/100</li>
                                    <li><strong>Severity:</strong> 
                                        <span class="badge ${analysis.cheating_severity === 'low' ? 'bg-success' : analysis.cheating_severity === 'medium' ? 'bg-warning' : 'bg-danger'}">
                                            ${analysis.cheating_severity || 'low'}
                                        </span>
                                    </li>
                                    <li><strong>Detected Violations:</strong></li>
                                    <li class="ms-3">
                                        ${analysis.cheating_violations && analysis.cheating_violations.length > 0 
                                            ? analysis.cheating_violations.map(v => `<small class="text-muted">‚Ä¢ ${v}</small>`).join('<br>')
                                            : '<small class="text-success">No violations detected</small>'
                                        }
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
    }
    
    determineLanguageLevel(score) {
        if (score >= 90) return 'C2';
        if (score >= 80) return 'C1';
        if (score >= 70) return 'B2';
        if (score >= 60) return 'B1';
        if (score >= 50) return 'A2';
        return 'A1';
    }
    
    generateStrengths(structure, fluency, vocabulary, intonation, rhythm, timing) {
        const strengths = [];
        
        if (structure >= 80) strengths.push(`Excellent structure and organization (${structure}%)`);
        if (fluency >= 80) strengths.push(`Good fluency and flow (${fluency}%)`);
        if (vocabulary >= 80) strengths.push(`Rich vocabulary usage (${vocabulary}%)`);
        if (intonation >= 80) strengths.push(`Good intonation and expression (${intonation}%)`);
        if (rhythm >= 80) strengths.push(`Natural rhythm and pacing (${rhythm}%)`);
        if (timing >= 80) strengths.push(`Good timing and delivery (${timing}%)`);
        
        // If no strengths, add general positive feedback
        if (strengths.length === 0) {
            strengths.push('Clear pronunciation and effort');
        }
        
        return strengths;
    }
    
    generateImprovements(structure, fluency, vocabulary, intonation, rhythm, timing) {
        const improvements = [];
        
        if (structure < 70) improvements.push(`Improve structure and organization (${structure}%)`);
        if (fluency < 70) improvements.push(`Work on fluency and flow (${fluency}%)`);
        if (vocabulary < 70) improvements.push(`Expand vocabulary range (${vocabulary}%)`);
        if (intonation < 70) improvements.push(`Practice intonation and expression (${intonation}%)`);
        if (rhythm < 70) improvements.push(`Improve rhythm and pacing (${rhythm}%)`);
        if (timing < 70) improvements.push(`Work on timing and delivery (${timing}%)`);
        
        // If no specific improvements, add general suggestions
        if (improvements.length === 0) {
            improvements.push('Continue practicing to maintain current level');
        }
        
        return improvements;
    }
    
    generateRecommendations(structure, fluency, vocabulary, intonation, rhythm, timing) {
        const recommendations = [];
        
        if (structure < 70) recommendations.push('Practice organizing your thoughts before speaking');
        if (fluency < 70) recommendations.push('Practice speaking more smoothly and reducing pauses');
        if (vocabulary < 70) recommendations.push('Learn new words and practice using them in context');
        if (intonation < 70) recommendations.push('Listen to native speakers and imitate their intonation');
        if (rhythm < 70) recommendations.push('Practice speaking with natural rhythm and stress patterns');
        if (timing < 70) recommendations.push('Work on timing your speech appropriately');
        
        // Add general recommendations
        recommendations.push('Practice speaking English daily');
        recommendations.push('Listen to English podcasts or videos');
        
        return recommendations.slice(0, 4); // Max 4 recommendations
    }
    
    parseRecommendations(feedback) {
        // Split feedback into recommendations
        const sentences = feedback.split(/[.!?]/).filter(s => s.trim().length > 10);
        return sentences.slice(0, 4); // Max 4 recommendations
    }
    
    displayResults() {
        // Fallback method for when backend fails
        console.log('‚ö†Ô∏è Using fallback results');
        
        // Generate realistic scores
        const overallScore = Math.floor(Math.random() * 40) + 60; // 60-100
        const originalityScore = Math.floor(Math.random() * 30) + 70;
        const structureScore = Math.floor(Math.random() * 30) + 70;
        const fluencyScore = Math.floor(Math.random() * 30) + 70;
        
        // Determine grade
        let grade = 'F';
        if (overallScore >= 90) grade = 'A';
        else if (overallScore >= 80) grade = 'B';
        else if (overallScore >= 70) grade = 'C';
        else if (overallScore >= 60) grade = 'D';
        
        // Determine language level
        const levels = ['A1', 'A2', 'B1', 'B2', 'C1', 'C2'];
        const level = levels[Math.floor(Math.random() * levels.length)];
        
        // Update UI
        document.getElementById('overallScore').textContent = overallScore;
        document.getElementById('gradeBadge').textContent = grade;
        document.getElementById('gradeBadge').className = `grade-badge grade-${grade}`;
        document.getElementById('languageLevel').textContent = level;
        document.getElementById('levelBadge').textContent = level;
        
        // Update progress bars
        document.getElementById('originalityBar').style.width = `${originalityScore}%`;
        document.getElementById('originalityScore').textContent = `${originalityScore}%`;
        document.getElementById('structureBar').style.width = `${structureScore}%`;
        document.getElementById('structureScore').textContent = `${structureScore}%`;
        document.getElementById('fluencyBar').style.width = `${fluencyScore}%`;
        document.getElementById('fluencyScore').textContent = `${fluencyScore}%`;
        
        // Generate strengths and improvements
        const strengths = [
            'Good pronunciation and clarity',
            'Well-structured sentences',
            'Appropriate vocabulary usage',
            'Good fluency and pace'
        ];
        
        const improvements = [
            'Work on more complex sentence structures',
            'Expand your vocabulary range',
            'Practice more natural intonation',
            'Focus on pronunciation of difficult sounds'
        ];
        
        const recommendations = [
            'Practice speaking daily for 15-20 minutes',
            'Listen to native speakers and repeat after them',
            'Record yourself and compare with native speakers',
            'Join conversation groups or language exchange programs'
        ];
        
        // Populate lists
        const strengthsList = document.getElementById('strengthsList');
        strengthsList.innerHTML = strengths.map(s => `<li class="strength-item">${s}</li>`).join('');
        
        const improvementsList = document.getElementById('improvementsList');
        improvementsList.innerHTML = improvements.map(i => `<li class="improvement-item">${i}</li>`).join('');
        
        const recommendationsList = document.getElementById('recommendationsList');
        recommendationsList.innerHTML = recommendations.map(r => `<li>${r}</li>`).join('');
        
        // Show results
        this.resultsSection.classList.remove('hidden');
        this.resultsSection.classList.add('fade-in');
        
        // Reset submit button
        this.submitBtn.innerHTML = '<i class="fas fa-robot me-2"></i>Submit for AI Teacher Evaluation';
        this.submitBtn.disabled = false;
        
        console.log('‚úÖ Fallback results displayed');
    }
    
    startRealtimeTranscription() {
        console.log('üé§ Starting AssemblyAI REAL-TIME transcription...');
        
        // Use AssemblyAI for real-time streaming transcription
        this.startAssemblyAIRealTimeTranscription();
    }
    
    async startAssemblyAIRealTimeTranscription() {
        console.log('üé§ Enregistrement en cours - Transcription AssemblyAI apr√®s l\'enregistrement');
        
        // Message CLAIR et HONN√äTE
        this.realtimeTranscription.innerHTML = `
            <div class="alert alert-primary">
                <h6><i class="fas fa-microphone me-2"></i>üé§ Enregistrement Audio en Cours...</h6>
                <p class="mb-3"><strong>Parlez maintenant, votre voix est enregistr√©e.</strong></p>
                <div class="bg-white p-4 rounded border text-center" style="min-height: 100px;">
                    <div class="mb-3">
                        <i class="fas fa-circle text-danger me-2" style="animation: pulse 1.5s infinite;"></i>
                        <span class="fw-bold">REC</span>
                    </div>
                    <p class="text-muted mb-0">
                        üîä Votre audio sera transcrit par AssemblyAI apr√®s l'enregistrement<br>
                        üìù Vous verrez votre transcription EXACTE apr√®s avoir cliqu√© sur "Submit"
                    </p>
                </div>
                <div class="mt-3 text-center">
                    <small class="text-success">
                        <i class="fas fa-check-circle me-1"></i>
                        Qualit√© audio optimale - Pr√™t pour transcription professionnelle
                    </small>
                </div>
            </div>
        `;
    }
    
    tryWebSpeechAPI() {
        console.log('üîÑ Web Speech API disabled due to network issues - using backend transcription');
        
        // DISABLE Web Speech API completely due to network issues
        // Skip directly to backend transcription
        return false;
    }
    
    tryGoogleCloudSpeech() {
        console.log('üîÑ Trying Google Cloud Speech...');
        
        // Check if we have Google Cloud Speech API available
        if (typeof google !== 'undefined' && google.speech) {
            try {
                this.realtimeTranscription.innerHTML = '<span class="text-info">üé§ Utilisation de Google Cloud Speech...</span>';
                
                // This would require Google Cloud Speech API setup
                // For now, fallback to manual transcription
                this.startFallbackTranscription();
                return true;
            } catch (error) {
                console.error('‚ùå Google Cloud Speech failed:', error);
                return false;
            }
        }
        
        return false;
    }
    
    startBackendTranscription() {
        console.log('üöÄ Starting BACKEND transcription system...');
        
        this.realtimeTranscription.innerHTML = `
            <div class="alert alert-success">
                <h6><i class="fas fa-server me-2"></i>Transcription Backend</h6>
                <p class="mb-2">Utilisation du syst√®me de transcription backend professionnel.</p>
                <div class="d-flex justify-content-between align-items-center">
                    <small class="text-muted">Pr√™t pour l'enregistrement...</small>
                    <div class="spinner-border spinner-border-sm text-success" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        `;
        
        // Start real-time simulation with backend
        this.simulateRealTimeTranscription();
    }
    
    startFallbackTranscription() {
        console.log('üîÑ Starting fallback transcription system...');
        
        this.realtimeTranscription.innerHTML = `
            <div class="alert alert-info">
                <h6><i class="fas fa-microphone me-2"></i>Transcription Automatique</h6>
                <p class="mb-2">Votre audio sera analys√© automatiquement par l'IA apr√®s l'enregistrement.</p>
                <div class="d-flex justify-content-between align-items-center">
                    <small class="text-muted">Transcription en cours...</small>
                    <div class="spinner-border spinner-border-sm" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        `;
        
        // Simulate real-time transcription with audio analysis
        this.simulateRealTimeTranscription();
    }
    
    simulateRealTimeTranscription() {
        // Try real-time transcription with backend API
        this.tryRealTimeTranscription();
    }
    
    async tryRealTimeTranscription() {
        console.log('üîÑ Trying real-time transcription with backend...');
        
        // Show initial message
        this.realtimeTranscription.innerHTML = `
            <div class="alert alert-info">
                <h6><i class="fas fa-microphone me-2"></i>Transcription en Temps R√©el</h6>
                <p class="mb-2">Analyse de votre discours en cours...</p>
                <div class="d-flex justify-content-between align-items-center">
                    <small class="text-muted">Connexion au service de transcription...</small>
                    <div class="spinner-border spinner-border-sm" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        `;
        
        // Simulate real-time updates with backend
        const messages = {
            'french': [
                'üé§ Enregistrement en cours...',
                'üì° Envoi vers le serveur de transcription...',
                'üß† Analyse IA en cours...',
                'üìù Transcription automatique active...',
                '‚úÖ Pr√™t pour l\'analyse finale...'
            ],
            'english': [
                'üé§ Recording in progress...',
                'üì° Sending to transcription server...',
                'üß† AI analysis in progress...',
                'üìù Automatic transcription active...',
                '‚úÖ Ready for final analysis...'
            ],
            'arabic': [
                'üé§ ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ ŸÇŸäÿØ ÿßŸÑÿ™ŸÇÿØŸÖ...',
                'üì° ÿ•ÿ±ÿ≥ÿßŸÑ ÿ•ŸÑŸâ ÿÆÿßÿØŸÖ ÿßŸÑŸÜÿ≥ÿÆ...',
                'üß† ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä ŸÇŸäÿØ ÿßŸÑÿ™ŸÇÿØŸÖ...',
                'üìù ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä ŸÜÿ¥ÿ∑...',
                '‚úÖ ÿ¨ÿßŸáÿ≤ ŸÑŸÑÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑŸÜŸáÿßÿ¶Ÿä...'
            ]
        };
        
        const languageMessages = messages[this.currentLanguage] || messages['french'];
        let messageIndex = 0;
        
        const updateInterval = setInterval(() => {
            if (!this.isRecording) {
                clearInterval(updateInterval);
                this.finalizeTranscription();
                return;
            }
            
            if (messageIndex < languageMessages.length) {
                this.realtimeTranscription.innerHTML = `
                    <div class="alert alert-info">
                        <h6><i class="fas fa-microphone me-2"></i>Transcription en Temps R√©el</h6>
                        <p class="mb-2">${languageMessages[messageIndex]}</p>
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">Analyse en cours...</small>
                            <div class="spinner-border spinner-border-sm" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                `;
                messageIndex++;
            }
        }, 2000);
    }
    
    async finalizeTranscription() {
        console.log('üéØ Finalizing transcription...');
        
        if (this.recordedAudio) {
            try {
                // Call backend transcription API
                const formData = new FormData();
                formData.append('audio', this.recordedAudio, 'recording.wav');
                formData.append('language', this.getLanguageCode());
                
                const response = await fetch('/assessments/api/voice-transcription/', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        this.transcriptionText = result.transcription;
                        this.realtimeTranscription.innerHTML = `
                            <div class="alert alert-success">
                                <h6><i class="fas fa-check-circle me-2"></i>Transcription R√©ussie</h6>
                                <p class="mb-2"><strong>Transcription:</strong> ${result.transcription}</p>
                                <small class="text-muted">M√©thode: ${result.method} | Confiance: ${Math.round(result.confidence * 100)}%</small>
                            </div>
                        `;
                        console.log('‚úÖ Real transcription received:', result.transcription);
                    } else {
                        this.showTranscriptionFallback();
                    }
                } else {
                    this.showTranscriptionFallback();
                }
            } catch (error) {
                console.error('‚ùå Transcription API error:', error);
                this.showTranscriptionFallback();
            }
        } else {
            this.showTranscriptionFallback();
        }
    }
    
    showTranscriptionFallback() {
        this.realtimeTranscription.innerHTML = `
            <div class="alert alert-warning">
                <h6><i class="fas fa-exclamation-triangle me-2"></i>Transcription Automatique</h6>
                <p class="mb-2">Votre audio sera analys√© automatiquement par l'IA apr√®s l'enregistrement.</p>
                <small class="text-muted">L'analyse se basera sur le contenu audio enregistr√©.</small>
            </div>
        `;
    }
    
    stopRealtimeTranscription() {
        console.log('üõë Enregistrement termin√© - Pr√™t pour transcription AssemblyAI');
        
        // Message clair apr√®s l'enregistrement
        this.realtimeTranscription.innerHTML = `
            <div class="alert alert-success">
                <h6><i class="fas fa-check-circle me-2"></i>‚úÖ Enregistrement Termin√©</h6>
                <p class="mb-3"><strong>Votre audio a √©t√© captur√© avec succ√®s !</strong></p>
                <div class="bg-white p-4 rounded border text-center" style="min-height: 100px;">
                    <div class="mb-3">
                        <i class="fas fa-check-circle text-success" style="font-size: 3rem;"></i>
                    </div>
                    <p class="text-muted mb-0">
                        üé§ Audio enregistr√©<br>
                        üìù Cliquez sur "Submit for AI Teacher Evaluation" pour voir votre transcription R√âELLE AssemblyAI<br>
                        üß† L'IA analysera VRAIMENT ce que vous avez dit
                    </p>
                </div>
                <div class="mt-3 text-center">
                    <small class="text-info">
                        <i class="fas fa-info-circle me-1"></i>
                        La transcription prendra 10-30 secondes (AssemblyAI traite votre audio)
                    </small>
                </div>
            </div>
        `;
    }
    
    updateTranscriptionDisplay(finalText, interimText) {
        this.realtimeTranscription.innerHTML = `
            <span class="text-dark">${finalText}</span>
            <span class="text-muted">${interimText}</span>
        `;
    }
    
    getLanguageCode() {
        const languageMap = {
            'french': 'fr-FR',
            'english': 'en-US',
            'arabic': 'ar-SA'
        };
        return languageMap[this.currentLanguage] || 'fr-FR';
    }
}

// Initialize the voice assessment when the page loads
document.addEventListener('DOMContentLoaded', () => {
    new SimpleVoiceAssessment();
});
</script>
{% endblock %}