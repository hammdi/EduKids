{% extends 'base/base.html' %}
{% load static %}

{% block title %}AI Story Correction - EduKids{% endblock %}

{% block content %}
<div class="story-correction-page">
    <div class="container py-5">
        <!-- Floating Sparkles Background -->
        <div class="sparkles-container">
            <div class="sparkle" style="left: 10%; top: 20%; animation-delay: 0s;">‚ú®</div>
            <div class="sparkle" style="left: 80%; top: 15%; animation-delay: 1s;">‚≠ê</div>
            <div class="sparkle" style="left: 15%; top: 70%; animation-delay: 2s;">üí´</div>
            <div class="sparkle" style="left: 85%; top: 60%; animation-delay: 1.5s;">üåü</div>
            <div class="sparkle" style="left: 50%; top: 10%; animation-delay: 0.5s;">‚ú®</div>
        </div>

        <!-- Header -->
        <div class="text-center mb-5">
            <h1 class="page-title">
                <span class="title-icon">‚úçÔ∏è</span>
                AI Story Correction
                <span class="title-icon">üìù</span>
            </h1>
            <p class="page-subtitle">Write your story and let AI help you make it even better! ‚ú®</p>
        </div>

        <!-- Main Form Card -->
        <div class="row justify-content-center mb-5">
            <div class="col-lg-10">
                <div class="story-form-card">
                    <h3 class="form-title">
                        <i class="fas fa-pen-fancy me-2"></i>Write Your Story
                    </h3>
                    
                    <form id="storyForm">
                        {% csrf_token %}
                        <div class="mb-4">
                            <label for="story_text" class="form-label">
                                üìñ Your Amazing Story
                            </label>
                            <textarea 
                                id="story_text" 
                                name="story_text" 
                                class="form-control story-textarea" 
                                rows="12" 
                                placeholder="Once upon a time... üåà

Write your story here! Let your imagination fly! ‚ú®"
                                required
                            ></textarea>
                            <div class="char-counter mt-2">
                                <span id="charCount">0</span> / 5000 characters
                            </div>
                        </div>

                        <div class="text-center">
                            <button type="submit" class="btn btn-magical-submit" id="submitBtn">
                                <span class="btn-icon">‚ú®</span>
                                Correct My Story
                                <span class="btn-icon">‚ú®</span>
                            </button>
                        </div>
                    </form>

                    <!-- Loading Spinner -->
                    <div id="loadingSpinner" class="loading-container" style="display: none;">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-3">ü™Ñ AI is reading your story...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Section (Hidden Initially) -->
        <div id="resultsSection" style="display: none;">
            <div class="row justify-content-center">
                <div class="col-lg-10">
                    <!-- Badge Earned -->
                    <div class="badge-earned-card mb-4">
                        <h3 class="text-center mb-4">
                            <i class="fas fa-trophy me-2"></i>Badge Earned!
                        </h3>
                        <div class="badge-display" id="badgeDisplay">
                            <!-- Badge will be inserted here -->
                        </div>
                        <div class="creativity-score text-center mt-3">
                            <span class="score-label">Creativity Score:</span>
                            <span class="score-value" id="creativityScore">0</span>/10 üåü
                        </div>
                    </div>

                    <!-- Feedback Card -->
                    <div class="feedback-card mb-4">
                        <div class="speech-bubble">
                            <div class="bubble-header">
                                <i class="fas fa-comment-dots me-2"></i>AI Feedback
                            </div>
                            <p class="feedback-text" id="feedbackText"></p>
                        </div>
                    </div>

                    <!-- Corrected Story Card -->
                    <div class="corrected-story-card mb-4">
                        <h4 class="card-title">
                            <i class="fas fa-check-circle me-2"></i>Corrected Version
                        </h4>
                        <div class="corrected-content" id="correctedStory"></div>
                    </div>

                    <!-- Questions Card -->
                    <div class="questions-card mb-4">
                        <h4 class="card-title">
                            <i class="fas fa-question-circle me-2"></i>Reflection Questions
                        </h4>
                        <div class="questions-list" id="questionsList"></div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="text-center mb-5">
                        <button class="btn btn-try-again" onclick="resetForm()">
                            <i class="fas fa-redo me-2"></i>Write Another Story
                        </button>
                        <a href="{% url 'assessments:student_badges' %}" class="btn btn-view-badges">
                            <i class="fas fa-trophy me-2"></i>View All Badges
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Previous Submissions -->
        {% if previous_assessments %}
        <div class="row justify-content-center mt-5">
            <div class="col-lg-10">
                <div class="previous-submissions-card">
                    <h3 class="section-title">
                        <i class="fas fa-history me-2"></i>Your Previous Stories
                    </h3>
                    <div class="submissions-grid">
                        {% for assessment in previous_assessments %}
                        <div class="submission-item">
                            <div class="submission-badge">
                                {% if assessment.badge == 'enchanted_storybook' %}
                                    <img src="{% static 'images/enchanted_storybook.png' %}" alt="Enchanted Storybook" class="badge-mini-image">
                                {% elif assessment.badge == 'adventure_scroll' %}
                                    <img src="{% static 'images/adventure_scroll.png' %}" alt="Adventure Scroll" class="badge-mini-image">
                                {% elif assessment.badge == 'fantasy_narrator' %}
                                    <img src="{% static 'images/fantasy_narrator.png' %}" alt="Fantasy Narrator" class="badge-mini-image">
                                {% elif assessment.badge == 'imagination_explorer' %}
                                    <img src="{% static 'images/imagination_explorer.png' %}" alt="Imagination Explorer" class="badge-mini-image">
                                {% endif %}
                            </div>
                            <div class="submission-info">
                                <div class="submission-date">
                                    <i class="fas fa-calendar me-1"></i>
                                    {{ assessment.created_at|date:"M d, Y" }}
                                </div>
                                <div class="submission-score">
                                    ‚≠ê {{ assessment.creativity_score }}/10
                                </div>
                            </div>
                            <a href="{% url 'assessments:view_story_assessment' assessment.id %}" class="btn btn-view-small">
                                View
                            </a>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<style>
    /* Page Background */
    .story-correction-page {
        background: linear-gradient(135deg, #FFF9F0 0%, #F0F9FF 50%, #FFF0F9 100%);
        min-height: 100vh;
        position: relative;
        overflow-x: hidden;
    }

    /* Floating Sparkles */
    .sparkles-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 1;
    }

    .sparkle {
        position: absolute;
        font-size: 2rem;
        animation: float 3s ease-in-out infinite;
        opacity: 0.6;
    }

    @keyframes float {
        0%, 100% { transform: translateY(0px) rotate(0deg); }
        50% { transform: translateY(-20px) rotate(180deg); }
    }

    /* Page Title */
    .page-title {
        font-size: 3rem;
        font-weight: 800;
        background: linear-gradient(135deg, #8B5CF6, #EC4899, #F59E0B);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 1rem;
        position: relative;
        z-index: 2;
    }

    .title-icon {
        font-size: 2.5rem;
        display: inline-block;
        animation: bounce 2s ease-in-out infinite;
    }

    @keyframes bounce {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-10px); }
    }

    .page-subtitle {
        font-size: 1.3rem;
        color: #6B7280;
        font-weight: 500;
    }

    /* Form Card */
    .story-form-card {
        background: white;
        padding: 3rem;
        border-radius: 30px;
        box-shadow: 0 10px 40px rgba(139, 92, 246, 0.15);
        position: relative;
        z-index: 2;
        border: 3px solid #F3E8FF;
    }

    .form-title {
        color: #8B5CF6;
        font-weight: 700;
        margin-bottom: 2rem;
        text-align: center;
    }

    .form-label {
        font-size: 1.1rem;
        font-weight: 600;
        color: #374151;
        margin-bottom: 0.5rem;
    }

    .story-textarea {
        border: 3px solid #E9D5FF;
        border-radius: 20px;
        padding: 1.5rem;
        font-size: 1.1rem;
        line-height: 1.8;
        transition: all 0.3s ease;
        font-family: 'Nunito', sans-serif;
    }

    .story-textarea:focus {
        border-color: #8B5CF6;
        box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.1);
        outline: none;
    }

    .char-counter {
        text-align: right;
        color: #9CA3AF;
        font-size: 0.9rem;
    }

    /* Submit Button */
    .btn-magical-submit {
        background: linear-gradient(135deg, #8B5CF6, #EC4899);
        border: none;
        color: white;
        padding: 1rem 3rem;
        font-size: 1.3rem;
        font-weight: 700;
        border-radius: 25px;
        box-shadow: 0 8px 20px rgba(139, 92, 246, 0.3);
        transition: all 0.3s ease;
    }

    .btn-magical-submit:hover {
        transform: translateY(-3px);
        box-shadow: 0 12px 30px rgba(139, 92, 246, 0.4);
        color: white;
    }

    .btn-icon {
        display: inline-block;
        animation: sparkle 1.5s ease-in-out infinite;
    }

    @keyframes sparkle {
        0%, 100% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.3); opacity: 0.7; }
    }

    /* Loading Spinner */
    .loading-container {
        text-align: center;
        padding: 3rem;
        color: #8B5CF6;
        font-size: 1.2rem;
        font-weight: 600;
    }

    /* Badge Earned Card */
    .badge-earned-card {
        background: linear-gradient(135deg, #FEF3C7, #FDE68A);
        padding: 2.5rem;
        border-radius: 25px;
        border: 3px dashed #F59E0B;
        box-shadow: 0 8px 25px rgba(245, 158, 11, 0.2);
        position: relative;
        z-index: 2;
    }

    .badge-display {
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        padding: 2rem;
    }

    .badge-image-large {
        width: 150px;
        height: 150px;
        object-fit: contain;
        filter: drop-shadow(0 8px 16px rgba(0,0,0,0.2));
        animation: badgePulse 2s ease-in-out infinite;
    }

    @keyframes badgePulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.1); }
    }

    .badge-name-large {
        font-size: 1.8rem;
        font-weight: 800;
        color: #92400E;
        margin-top: 1rem;
    }

    .creativity-score {
        font-size: 1.3rem;
        font-weight: 700;
        color: #92400E;
    }

    .score-value {
        font-size: 2rem;
        color: #F59E0B;
    }

    /* Feedback Card */
    .feedback-card {
        position: relative;
        z-index: 2;
    }

    .speech-bubble {
        background: linear-gradient(135deg, #E0E7FF, #DBEAFE);
        padding: 2.5rem;
        border-radius: 25px;
        position: relative;
        box-shadow: 0 8px 25px rgba(99, 102, 241, 0.15);
        border: 3px solid #C7D2FE;
    }

    .speech-bubble::before {
        content: '';
        position: absolute;
        top: -15px;
        left: 50px;
        width: 0;
        height: 0;
        border-left: 15px solid transparent;
        border-right: 15px solid transparent;
        border-bottom: 15px solid #C7D2FE;
    }

    .bubble-header {
        font-size: 1.3rem;
        font-weight: 700;
        color: #4338CA;
        margin-bottom: 1rem;
    }

    .feedback-text {
        font-size: 1.2rem;
        color: #1E3A8A;
        line-height: 1.8;
        margin: 0;
    }

    /* Corrected Story Card */
    .corrected-story-card {
        background: linear-gradient(135deg, #F0FDF4, #DCFCE7);
        padding: 2.5rem;
        border-radius: 25px;
        box-shadow: 0 8px 25px rgba(34, 197, 94, 0.15);
        border: 3px solid #BBF7D0;
        position: relative;
        z-index: 2;
    }

    .card-title {
        color: #15803D;
        font-weight: 700;
        margin-bottom: 1.5rem;
    }

    .corrected-content {
        background: white;
        padding: 2rem;
        border-radius: 15px;
        font-size: 1.1rem;
        line-height: 1.9;
        color: #374151;
        white-space: pre-wrap;
    }

    /* Questions Card */
    .questions-card {
        background: linear-gradient(135deg, #FCE7F3, #FBE7F3);
        padding: 2.5rem;
        border-radius: 25px;
        box-shadow: 0 8px 25px rgba(236, 72, 153, 0.15);
        border: 3px solid #FBCFE8;
        position: relative;
        z-index: 2;
    }

    .questions-list {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .question-item {
        background: white;
        padding: 1.5rem;
        border-radius: 15px;
        border-left: 5px solid #EC4899;
        box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }

    .question-number {
        display: inline-block;
        background: #EC4899;
        color: white;
        padding: 0.3rem 0.8rem;
        border-radius: 10px;
        font-weight: 700;
        font-size: 0.9rem;
        margin-right: 0.5rem;
    }

    .question-text {
        font-size: 1.1rem;
        color: #374151;
        font-weight: 600;
    }

    /* Action Buttons */
    .btn-try-again {
        background: linear-gradient(135deg, #F59E0B, #FBBF24);
        border: none;
        color: white;
        padding: 0.8rem 2rem;
        font-size: 1.1rem;
        font-weight: 600;
        border-radius: 20px;
        margin: 0.5rem;
        transition: all 0.3s ease;
    }

    .btn-try-again:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(245, 158, 11, 0.3);
        color: white;
    }

    .btn-view-badges {
        background: linear-gradient(135deg, #8B5CF6, #A78BFA);
        border: none;
        color: white;
        padding: 0.8rem 2rem;
        font-size: 1.1rem;
        font-weight: 600;
        border-radius: 20px;
        margin: 0.5rem;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-block;
    }

    .btn-view-badges:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(139, 92, 246, 0.3);
        color: white;
    }

    /* Previous Submissions */
    .previous-submissions-card {
        background: white;
        padding: 2.5rem;
        border-radius: 25px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        border: 3px solid #F3F4F6;
        position: relative;
        z-index: 2;
    }

    .section-title {
        color: #1F2937;
        font-weight: 700;
        margin-bottom: 2rem;
    }

    .submissions-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 1.5rem;
    }

    .submission-item {
        background: linear-gradient(135deg, #F9FAFB, #F3F4F6);
        padding: 1.5rem;
        border-radius: 15px;
        border: 2px solid #E5E7EB;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1rem;
        transition: all 0.3s ease;
    }

    .submission-item:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    }

    .badge-mini-image {
        width: 60px;
        height: 60px;
        object-fit: contain;
        filter: drop-shadow(0 4px 8px rgba(0,0,0,0.15));
    }

    .submission-info {
        text-align: center;
        flex-grow: 1;
    }

    .submission-date {
        color: #6B7280;
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
    }

    .submission-score {
        font-size: 1.1rem;
        font-weight: 700;
        color: #F59E0B;
    }

    .btn-view-small {
        background: #8B5CF6;
        color: white;
        padding: 0.5rem 1.5rem;
        border-radius: 10px;
        text-decoration: none;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    .btn-view-small:hover {
        background: #7C3AED;
        color: white;
        transform: scale(1.05);
    }

    /* Responsive */
    @media (max-width: 768px) {
        .page-title {
            font-size: 2rem;
        }

        .story-form-card {
            padding: 2rem;
        }

        .submissions-grid {
            grid-template-columns: 1fr;
        }
    }
</style>

<script>
    // Character counter
    const textarea = document.getElementById('story_text');
    const charCount = document.getElementById('charCount');

    textarea.addEventListener('input', function() {
        charCount.textContent = this.value.length;
        
        if (this.value.length > 5000) {
            charCount.style.color = '#EF4444';
        } else {
            charCount.style.color = '#9CA3AF';
        }
    });

    // Form submission
    const form = document.getElementById('storyForm');
    const submitBtn = document.getElementById('submitBtn');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const resultsSection = document.getElementById('resultsSection');

    form.addEventListener('submit', async function(e) {
        e.preventDefault();

        const storyText = textarea.value.trim();

        if (!storyText) {
            alert('Please write a story before submitting!');
            return;
        }

        if (storyText.length < 20) {
            alert('Your story is too short! Please write at least 20 characters.');
            return;
        }

        // Show loading
        submitBtn.style.display = 'none';
        loadingSpinner.style.display = 'block';
        resultsSection.style.display = 'none';

        // Get CSRF token
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        try {
            const response = await fetch('{% url "assessments:submit_story_correction" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    'story_text': storyText
                })
            });

            const result = await response.json();

            if (result.success) {
                displayResults(result.data);
            } else {
                alert(result.error || 'Something went wrong. Please try again!');
                submitBtn.style.display = 'block';
                loadingSpinner.style.display = 'none';
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Network error. Please check your connection and try again!');
            submitBtn.style.display = 'block';
            loadingSpinner.style.display = 'none';
        }
    });

    function displayResults(data) {
        // Hide loading
        loadingSpinner.style.display = 'none';

        // Display badge
        const badgeDisplay = document.getElementById('badgeDisplay');
        const badgeImages = {
            'enchanted_storybook': '{% static "images/enchanted_storybook.png" %}',
            'adventure_scroll': '{% static "images/adventure_scroll.png" %}',
            'fantasy_narrator': '{% static "images/fantasy_narrator.png" %}',
            'imagination_explorer': '{% static "images/imagination_explorer.png" %}'
        };
        const badgeNames = {
            'enchanted_storybook': 'üìñ Enchanted Storybook',
            'adventure_scroll': 'üìú Adventure Scroll',
            'fantasy_narrator': 'üé≠ Fantasy Narrator',
            'imagination_explorer': 'üåü Imagination Explorer'
        };

        badgeDisplay.innerHTML = `
            <img src="${badgeImages[data.badge]}" alt="${badgeNames[data.badge]}" class="badge-image-large">
            <div class="badge-name-large">${badgeNames[data.badge]}</div>
        `;

        // Display creativity score
        document.getElementById('creativityScore').textContent = data.creativity_score;

        // Display feedback
        document.getElementById('feedbackText').textContent = data.feedback;

        // Display corrected story
        document.getElementById('correctedStory').textContent = data.corrected_story;

        // Display questions
        const questionsList = document.getElementById('questionsList');
        questionsList.innerHTML = data.questions.map((q, i) => `
            <div class="question-item">
                <span class="question-number">Q${i + 1}</span>
                <span class="question-text">${q}</span>
            </div>
        `).join('');

        // Show results section
        resultsSection.style.display = 'block';

        // Scroll to results
        resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function resetForm() {
        // Reset form
        form.reset();
        charCount.textContent = '0';

        // Hide results
        resultsSection.style.display = 'none';

        // Show submit button
        submitBtn.style.display = 'block';

        // Scroll to top
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
</script>
{% endblock %}
